<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Jugador - {{ perfil.nombre }}</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/Icono.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/style.css">
    <style>
        /* Estilos generales adaptados para móvil */
        body {
            transition: background-color 0.3s, color 0.3s;
            padding-top: 56px; /* Ajuste para el navbar fijo */
            background-color: #f8f9fa; /* Color de fondo claro por defecto */
        }

        .dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        .dark-mode .navbar {
            background-color: #212529 !important;
            color: white;
        }

        .dark-mode .card {
            background-color: #212529;
            color: white;
        }

        .dark-mode .list-group-item {
            background-color: #212529;
            color: white;
            border-color: #343a40;
        }

        .dark-mode .form-control, .dark-mode .form-select {
            background-color: #343a40;
            color: white;
            border-color: #495057;
        }
        
        .navbar-brand img {
            width: 24px;
            height: 24px;
        }

        .container {
            padding: 0 15px;
        }

        /* Ocultar banners laterales en móvil */
        .lateral-img {
            display: none;
        }

        .banner-img {
            margin-top: 20px;
            width: 100%;
            height: auto;
            object-fit: cover;
            border-radius: 10px;
        }

        .profile-header {
            text-align: center;
            margin: 20px 0;
        }

        .profile-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #007bff;
            margin-bottom: 10px;
        }

        .opgg-link {
            display: block;
            margin: 10px auto;
            padding: 8px 15px;
            font-size: 0.9em;
            font-weight: bold;
            color: white !important;
            background-color: #007bff;
            border-radius: 20px;
            text-decoration: none;
            transition: background-color 0.2s ease-in-out;
            max-width: 200px;
        }

        .opgg-link:hover {
            background-color: #0056b3;
        }

        .rank-card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .rank-card .card-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .rank-card .card-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
        }

        .rank-card .elo-image-lg {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .rank-details {
            text-align: center;
            width: 100%;
        }

        .rank-details h4 {
            font-size: 1.2em;
        }

        .rank-details p {
            font-size: 0.9em;
            margin-bottom: 3px;
        }
        
        .champion-stats-container {
            width: 100%;
        }

        .champion-stats-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .dark-mode .champion-stats-item {
            border-bottom-color: #343a40;
        }

        .champion-stats-item:last-child {
            border-bottom: none;
        }

        .champion-stats-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
        }
        
        .champion-stats-info {
            flex-grow: 1;
        }

        .champion-stats-info h5 {
            font-size: 1em;
            margin: 0;
        }

        .kda-text {
            font-size: 0.8em;
            color: #6c757d;
        }

        .win-rate-text {
            font-size: 0.8em;
            font-weight: bold;
        }

        /* Historial de partidas simplificado para móvil */
        .match-history-card .card-body {
            padding: 0;
        }

        .match-row {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .dark-mode .match-row {
            border-bottom-color: #343a40;
        }

        .match-row-win { background-color: rgba(40, 167, 69, 0.08); }
        .match-row-loss { background-color: rgba(220, 53, 69, 0.08); }
        .dark-mode .match-row-win { background-color: rgba(40, 167, 69, 0.15); }
        .dark-mode .match-row-loss { background-color: rgba(220, 53, 69, 0.15); }

        .match-info-main {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
        }

        .match-info-champ-stats {
            text-align: center;
            width: 80px;
        }
        
        .match-info-kda {
            text-align: center;
            width: 80px;
        }
        
        .match-info-result {
            text-align: center;
            width: 60px;
        }
        
        .lp-change-text {
            font-size: 0.8em;
            font-weight: bold;
        }

        .lp-change-win {
            color: #28a745;
        }
        
        .lp-change-loss {
            color: #dc3545;
        }
        
        .champion-level-container {
            position: relative;
            width: 40px;
            height: 40px;
        }
        
        .champion-level-container img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .champion-level {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: #343a40;
            color: white;
            font-size: 0.7em;
            width: 20px;
            height: 20px;
            line-height: 20px;
            border-radius: 50%;
            text-align: center;
            border: 1px solid #6c757d;
        }

        .match-row .summoner-spells, .match-row .runes {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-left: 5px;
        }

        .match-row .summoner-spells img, .match-row .runes img {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .match-row .runes img {
            border-radius: 50%;
        }

        .kda-text-mobile {
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .match-result-mobile {
            font-size: 0.9em;
            font-weight: bold;
        }

        /* Estilos para los filtros y paginación en móvil */
        .filter-controls {
            flex-direction: column;
            gap: 10px;
        }

        .filter-controls .form-select {
            width: 100%;
        }
        
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }

        /* Estilos para el detalle de la partida en móvil */
        .match-details-row {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .dark-mode .match-details-row {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .details-content-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.4s ease-in-out;
        }
        
        .match-details-row:not(.hidden) .details-content-wrapper {
            grid-template-rows: 1fr;
        }

        .details-content-wrapper > div {
            overflow: hidden;
            padding: 0 10px;
        }

        .damage-bar-container {
            margin-top: 10px;
        }
        
        .damage-bar {
            height: 10px;
        }
    </style>
</head>

<body>

    <!-- Los banners laterales se ocultan por CSS en móvil -->
    <img id="left-banner" class="lateral-img left-img" src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/1.jpg" alt="Lateral izquierda">
    <img id="right-banner" class="lateral-img right-img" src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/1.jpg" alt="Lateral derecha">

    <audio id="backgroundAudio" loop>
        <source src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/backgroundMusic.mp3" type="audio/mpeg">
        Tu navegador no soporta el elemento audio.
    </audio>

    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/Icono2.jpg" alt="Logo" style="vertical-align: middle; margin-right: 8px;">
                Cerditos y Valientes
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
                aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 flex-column flex-lg-row">
                </ul>
                <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center">
                    <button id="toggle-mode" class="btn btn-secondary w-100 w-lg-auto mb-2 mb-lg-0">Modo Oscuro</button>
                    <div class="d-flex align-items-center ms-lg-2">
                        <button id="toggleAudio" class="btn btn-secondary" title="Desmutear Música">
                            <i id="muteIcon" class="fas fa-microphone-slash"></i>
                        </button>
                        <input id="volumeSlider" type="range" class="form-range" min="0" max="1" step="0.01" value="1">
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-5">
        <div class="d-flex justify-content-center">
            <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/refs/heads/main/banners/Banner5.png" alt="Banner" class="banner-img" id="banner-img">
        </div>

        <div class="profile-header">
            <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/img_perfil/{{ perfil.nombre }}.png" alt="Imagen de {{ perfil.nombre }}" onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/img_perfil/{{ perfil.nombre }}.png'; if (this.src === 'https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/img_perfil/{{ perfil.nombre }}.png') { this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'><circle cx=\'50\' cy=\'50\' r=\'50\' fill=\'white\'/></svg>'; }">
            <h1>{{ perfil.nombre }} <span class="small-text">({{ perfil.game_name }})</span></h1>
            <a href="https://www.op.gg/summoners/euw/{{ perfil.game_name | replace('#', '-') }}" target="_blank" class="opgg-link">Ver en OP.GG</a>
        </div>
        
        <div class="row">
            <div class="col-12 col-md-6 mb-3">
                <div class="card rank-card">
                    <div class="card-header">Clasificatoria Solo/Duo</div>
                    <div class="card-body">
                        {% if perfil.soloq %}
                        <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/elo_images/{{ perfil.soloq.tier }}.png" alt="{{ perfil.soloq.tier }}" class="elo-image-lg">
                        <div class="rank-details">
                            <h4>{{ perfil.soloq.tier }} {{ perfil.soloq.rank }} ({{ perfil.soloq.league_points }} LPs)</h4>
                            <p>Wins: {{ perfil.soloq.wins }} | Losses: {{ perfil.soloq.losses }}</p>
                            {% set soloq_total_games = perfil.soloq.wins + perfil.soloq.losses %}
                            {% set soloq_win_rate = (perfil.soloq.wins / soloq_total_games * 100) if soloq_total_games > 0 else 0 %}
                            <p class="{% if soloq_win_rate >= 50 %}win-rate-alto{% else %}win-rate-bajo{% endif %}">
                                Win Rate: {{ '%.2f'|format(soloq_win_rate) }}%
                            </p>
                            <p class="peak-elo">Peak Elo: {{ perfil.soloq.get('peak_elo', 0) | format_peak_elo }}</p>
                        </div>
                        {% else %}
                        <div class="rank-details">
                            <h4>Unranked</h4>
                            <p>Sin datos de Solo/Duo</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 mb-3">
                <div class="card rank-card">
                    <div class="card-header">Clasificatoria Flexible</div>
                    <div class="card-body">
                        {% if perfil.flex %}
                        <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/elo_images/{{ perfil.flex.tier }}.png" alt="{{ perfil.flex.tier }}" class="elo-image-lg">
                        <div class="rank-details">
                            <h4>{{ perfil.flex.tier }} {{ perfil.flex.rank }} ({{ perfil.flex.league_points }} LPs)</h4>
                            <p>Wins: {{ perfil.flex.wins }} | Losses: {{ perfil.flex.losses }}</p>
                            {% set flex_total_games = perfil.flex.wins + perfil.flex.losses %}
                            {% set flex_win_rate = (perfil.flex.wins / flex_total_games * 100) if flex_total_games > 0 else 0 %}
                            <p class="{% if flex_win_rate >= 50 %}win-rate-alto{% else %}win-rate-bajo{% endif %}">
                                Win Rate: {{ '%.2f'|format(flex_win_rate) }}%
                            </p>
                            <p class="peak-elo">Peak Elo: {{ perfil.flex.get('peak_elo', 0) | format_peak_elo }}</p>
                        </div>
                        {% else %}
                        <div class="rank-details">
                            <h4>Unranked</h4>
                            <p>Sin datos de Flexible</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Estadísticas de Campeones -->
        <div class="card my-4">
            <div class="card-header fw-bold">Estadísticas de Campeones</div>
            <div class="card-body champion-stats-container">
                {% if perfil.soloq and perfil.soloq.top_champion_stats %}
                {% for champion_stat in perfil.soloq.top_champion_stats %}
                <div class="champion-stats-item">
                    <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ champion_stat.champion_name }}.png" alt="{{ champion_stat.champion_name }}">
                    <div class="champion-stats-info">
                        <h5>{{ champion_stat.champion_name }}</h5>
                        <p class="kda-text">{{ '%.2f'|format(champion_stat.kda) }} KDA</p>
                        <p class="win-rate-text {% if champion_stat.win_rate >= 50 %}win-rate-alto{% else %}win-rate-bajo{% endif %}">{{ '%.0f'|format(champion_stat.win_rate) }}% Win Rate ({{ champion_stat.games_played }} games)</p>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-center text-muted">No hay datos de campeones disponibles.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Sección del historial de partidas (tabla simplificada) -->
        <div class="card my-4 match-history-card">
            <div class="card-header fw-bold">Historial de Partidas</div>
            <div class="card-body">
                <div class="filter-controls">
                    <label for="queueFilter">Modo:</label>
                    <select id="queueFilter" class="form-select"></select>

                    <label for="championFilter">Campeón:</label>
                    <select id="championFilter" class="form-select"></select>
                </div>
                
                <div id="matchHistoryContainer" class="list-group list-group-flush">
                    <!-- Aquí se renderizarán las partidas del historial -->
                </div>
                
                <div id="paginationControls" class="pagination-container">
                    <nav>
                        <ul class="pagination">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" data-page="1">Anterior</a>
                            </li>
                            <li class="page-item active">
                                <a class="page-link" href="#" data-page="1">1</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#" data-page="2">Siguiente</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-5">
        <p class="text-center text-muted">Datos extraídos de SoloQ Cerditos</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Lógica de audio y modo oscuro
        document.addEventListener('DOMContentLoaded', () => {
            const backgroundAudio = document.getElementById('backgroundAudio');
            const toggleAudioBtn = document.getElementById('toggleAudio');
            const volumeSlider = document.getElementById('volumeSlider');
            const muteIcon = document.getElementById('muteIcon');
            const toggleModeBtn = document.getElementById('toggle-mode');
            const body = document.body;

            const audioVolume = localStorage.getItem('audioVolume') || 1;
            const isAudioMuted = localStorage.getItem('isAudioMuted') === 'true';
            const isDarkMode = localStorage.getItem('darkMode') === 'true';

            backgroundAudio.volume = isAudioMuted ? 0 : audioVolume;
            volumeSlider.value = audioVolume;

            if (isAudioMuted) {
                muteIcon.classList.remove('fa-microphone');
                muteIcon.classList.add('fa-microphone-slash');
                toggleAudioBtn.title = 'Desmutear Música';
            } else {
                muteIcon.classList.remove('fa-microphone-slash');
                muteIcon.classList.add('fa-microphone');
                toggleAudioBtn.title = 'Mutear Música';
            }

            if (isDarkMode) {
                body.classList.add('dark-mode');
                toggleModeBtn.textContent = 'Modo Claro';
            } else {
                body.classList.remove('dark-mode');
                toggleModeBtn.textContent = 'Modo Oscuro';
            }

            toggleAudioBtn.addEventListener('click', () => {
                if (backgroundAudio.muted) {
                    backgroundAudio.muted = false;
                    muteIcon.classList.remove('fa-microphone-slash');
                    muteIcon.classList.add('fa-microphone');
                    toggleAudioBtn.title = 'Mutear Música';
                    localStorage.setItem('isAudioMuted', 'false');
                } else {
                    backgroundAudio.muted = true;
                    muteIcon.classList.remove('fa-microphone');
                    muteIcon.classList.add('fa-microphone-slash');
                    toggleAudioBtn.title = 'Desmutear Música';
                    localStorage.setItem('isAudioMuted', 'true');
                }
            });

            volumeSlider.addEventListener('input', () => {
                backgroundAudio.volume = volumeSlider.value;
                localStorage.setItem('audioVolume', volumeSlider.value);
                backgroundAudio.muted = volumeSlider.value == 0;
                if (backgroundAudio.muted) {
                     muteIcon.classList.remove('fa-microphone');
                    muteIcon.classList.add('fa-microphone-slash');
                    toggleAudioBtn.title = 'Desmutear Música';
                    localStorage.setItem('isAudioMuted', 'true');
                } else {
                    muteIcon.classList.remove('fa-microphone-slash');
                    muteIcon.classList.add('fa-microphone');
                    toggleAudioBtn.title = 'Mutear Música';
                    localStorage.setItem('isAudioMuted', 'false');
                }
            });

            toggleModeBtn.addEventListener('click', () => {
                body.classList.toggle('dark-mode');
                const isDark = body.classList.contains('dark-mode');
                localStorage.setItem('darkMode', isDark);
                toggleModeBtn.textContent = isDark ? 'Modo Claro' : 'Modo Oscuro';
            });
            
            // Lógica para que el audio se reproduzca al interactuar con la página
            function playAudio() {
                if (backgroundAudio.paused) {
                    backgroundAudio.play().catch(error => {
                        console.log("No se pudo reproducir el audio: ", error);
                    });
                }
            }
            document.addEventListener('click', playAudio, { once: true });
        });
        
        // --- INICIO: LÓGICA DE FILTRADO Y PAGINACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Los datos del historial de partidas se inyectarán aquí desde el servidor.
            // Ejemplo de estructura esperada (debe ser un array de objetos):
            // const matchHistoryData = [
            //   { matchId: '...', queueId: 420, championName: '...', win: true, lpChange: 25, ... },
            //   ...
            // ];
            const matchHistoryData = []; // Esta variable se llenará con los datos de tu backend
            
            // Los datos del perfil se inyectarán aquí desde el servidor.
            const perfil = {
                nombre: '{{ perfil.nombre }}',
                game_name: '{{ perfil.game_name }}',
                soloq: {{ perfil.soloq | tojson }},
                flex: {{ perfil.flex | tojson }}
            };


            const matchHistoryContainer = document.getElementById('matchHistoryContainer');
            const queueFilter = document.getElementById('queueFilter');
            const championFilter = document.getElementById('championFilter');
            const paginationControls = document.getElementById('paginationControls');

            let currentPage = 1;
            const itemsPerPage = 10;
            let filteredData = [];

            // Mapeo de queueId a nombre de cola
            const queueNames = {
                420: "Solo/Duo",
                440: "Flexible",
                450: "ARAM",
                700: "Clash",
                // Añade más colas si es necesario
            };
            
            // Asume que los datos vienen de la plantilla del servidor
            if (typeof matchHistoryServerData !== 'undefined') {
                matchHistoryData.push(...matchHistoryServerData);
            }
            
            const populateQueueFilter = () => {
                const uniqueQueues = [...new Set(matchHistoryData.map(match => match.queueId))];
                queueFilter.innerHTML = '<option value="all">Todos los modos</option>';
                uniqueQueues.forEach(queueId => {
                    const option = document.createElement('option');
                    option.value = queueId;
                    option.textContent = queueNames[queueId] || `Cola ${queueId}`;
                    queueFilter.appendChild(option);
                });
            };

            const populateChampionFilter = () => {
                const uniqueChampions = [...new Set(matchHistoryData.map(match => match.championName))];
                championFilter.innerHTML = '<option value="all">Todos los campeones</option>';
                uniqueChampions.forEach(champion => {
                    const option = document.createElement('option');
                    option.value = champion;
                    option.textContent = champion;
                    championFilter.appendChild(option);
                });
            };

            const renderMatchHistory = () => {
                const selectedQueue = queueFilter.value;
                const selectedChampion = championFilter.value;

                filteredData = matchHistoryData.filter(match => {
                    const queueMatch = selectedQueue === 'all' || match.queueId.toString() === selectedQueue;
                    const championMatch = selectedChampion === 'all' || match.championName === selectedChampion;
                    return queueMatch && championMatch;
                });

                const totalPages = Math.ceil(filteredData.length / itemsPerPage);
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const currentMatches = filteredData.slice(startIndex, endIndex);

                matchHistoryContainer.innerHTML = '';
                currentMatches.forEach(match => {
                    const winClass = match.win ? 'match-row-win' : 'match-row-loss';
                    const winText = match.win ? 'VICTORIA' : 'DERROTA';
                    const kdaColor = match.kda >= 4 ? 'text-success' : (match.kda >= 2.5 ? 'text-warning' : 'text-danger');
                    const multikillBadge = match.multikill ? `<span class="multikill-badge ${match.multikill.toLowerCase().replace(' ', '-')}" title="${match.multikill}">${match.multikill}</span>` : '';
                    
                    const lpSign = match.lpChange > 0 ? '+' : '';
                    const lpColor = match.lpChange > 0 ? 'lp-change-win' : 'lp-change-loss';
                    
                    const matchCard = document.createElement('div');
                    matchCard.classList.add('list-group-item', 'match-row', winClass, 'flex-column', 'align-items-start');
                    matchCard.setAttribute('data-bs-toggle', 'collapse');
                    matchCard.setAttribute('data-bs-target', `#match-details-${match.matchId}`);
                    matchCard.setAttribute('aria-expanded', 'false');
                    matchCard.setAttribute('aria-controls', `match-details-${match.matchId}`);
                    
                    matchCard.innerHTML = `
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="champion-level-container me-2">
                                    <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/${match.championName}.png" alt="${match.championName}">
                                    <span class="champion-level">${match.championLevel}</span>
                                </div>
                                <div class="match-info-result">
                                    <span class="match-result-mobile ${match.win ? 'text-success' : 'text-danger'}">${winText}</span>
                                    <span class="lp-change-text ${lpColor} d-block">${lpSign}${match.lpChange} LPs</span>
                                </div>
                            </div>
                            
                            <div class="text-center mx-2">
                                <div class="kda-text-mobile">
                                    <span class="${kdaColor}">${match.kda} KDA</span>
                                </div>
                                <div class="text-muted small-text">
                                    ${match.kills} / ${match.deaths} / ${match.assists}
                                </div>
                            </div>
                            
                            <div class="d-flex align-items-center">
                                <div class="d-flex flex-column align-items-center me-2">
                                    <div class="summoner-spells mb-1">
                                        <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/${match.summonerSpells[0]}.png" alt="Spell1">
                                        <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/${match.summonerSpells[1]}.png" alt="Spell2">
                                    </div>
                                    <div class="runes">
                                        <img src="https://ddragon.leagueoflegends.com/cdn/img/perk-images/${match.runes[0]}.png" alt="Keystone">
                                        <img src="https://ddragon.leagueoflegends.com/cdn/img/perk-images/${match.runes[1]}.png" alt="Sub Rune">
                                    </div>
                                </div>
                                
                                <div class="items-layout">
                                    <div class="items-grid">
                                        ${match.items.map(item => `
                                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/item/${item}.png" alt="Item" onerror="this.src='https://placehold.co/20x20/343a40/FFFFFF?text=?'">
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    matchHistoryContainer.appendChild(matchCard);

                    // Detalles de la partida colapsables
                    const detailsRow = document.createElement('div');
                    detailsRow.classList.add('collapse');
                    detailsRow.id = `match-details-${match.matchId}`;
                    detailsRow.innerHTML = `
                        <div class="card card-body mt-2 match-details-row">
                            <h6 class="fw-bold">Detalles de la partida</h6>
                            <div class="damage-bar-container">
                                <p class="small mb-1">Daño infligido</p>
                                <div class="progress damage-bar" role="progressbar" aria-label="Damage progress">
                                    <div class="progress-bar damage-physical" style="width: ${match.damagePhysical}%"></div>
                                    <div class="progress-bar damage-magic" style="width: ${match.damageMagic}%"></div>
                                    <div class="progress-bar damage-true" style="width: ${match.damageTrue}%"></div>
                                </div>
                            </div>
                            <div class="players-list mt-3">
                                <h6 class="small fw-bold">Jugadores:</h6>
                                <ul class="list-group list-group-flush">
                                    ${match.players.map(p => `
                                        <li class="list-group-item d-flex align-items-center">
                                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/${p.champ}.png" alt="${p.champ}" class="me-2 rounded-circle" style="width: 20px; height: 20px;">
                                            <span class="small">${p.name} - ${p.champ}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                    matchHistoryContainer.appendChild(detailsRow);

                });

                renderPagination(totalPages);
            };

            const renderPagination = (totalPages) => {
                const paginationUl = paginationControls.querySelector('.pagination');
                paginationUl.innerHTML = '';
                
                // Botón "Anterior"
                const prevLi = document.createElement('li');
                prevLi.classList.add('page-item');
                if (currentPage === 1) prevLi.classList.add('disabled');
                prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Anterior</a>`;
                paginationUl.appendChild(prevLi);

                // Botones de página
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageLi = document.createElement('li');
                    pageLi.classList.add('page-item');
                    if (i === currentPage) pageLi.classList.add('active');
                    pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                    paginationUl.appendChild(pageLi);
                }

                // Botón "Siguiente"
                const nextLi = document.createElement('li');
                nextLi.classList.add('page-item');
                if (currentPage === totalPages) nextLi.classList.add('disabled');
                nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Siguiente</a>`;
                paginationUl.appendChild(nextLi);
            };

            // --- EVENT LISTENERS ---
            queueFilter.addEventListener('change', () => {
                currentPage = 1;
                renderMatchHistory();
            });

            championFilter.addEventListener('change', () => {
                currentPage = 1;
                renderMatchHistory();
            });

            paginationControls.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('.page-link');
                if (!target || target.parentElement.classList.contains('disabled') || target.parentElement.classList.contains('active')) return;
                
                const newPage = parseInt(target.dataset.page, 10);
                if (!isNaN(newPage) && newPage >= 1 && newPage <= Math.ceil(filteredData.length / itemsPerPage)) {
                    currentPage = newPage;
                    renderMatchHistory();
                }
            });
            
            // --- INICIALIZACIÓN ---
            populateQueueFilter();
            populateChampionFilter();
            renderMatchHistory();
            // --- FIN: LÓGICA DE FILTRADO Y PAGINACIÓN ---
        });
    </script>
</body>

</html>