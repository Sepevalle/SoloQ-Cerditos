<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas Globales - Cerditos y Valientes</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/Icono.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/style.css">
    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        .dark-mode { background-color: #121212; color: #ffffff; }
        .dark-mode .navbar { background-color: #343a40 !important; color: white; }
        .dark-mode .navbar-brand, .dark-mode .nav-link { color: white !important; }
        .dark-mode .table, .dark-mode .card { background-color: #343a40 !important; color: white; }
        .dark-mode .nav-tabs { border-color: #6c757d; }
        .dark-mode .nav-tabs .nav-link { 
            color: #adb5bd !important;
            border-color: transparent;
        }
        .dark-mode .nav-tabs .nav-link:hover {
            border-color: #6c757d;
            color: #e0e0e0 !important;
        }
        .dark-mode .nav-tabs .nav-link.active { 
            background-color: #495057 !important;
            border-color: #6c757d #6c757d #495057 !important;
            color: #fff !important;
        }
        .dark-mode .navbar-toggler-icon { filter: invert(1) grayscale(100%) brightness(2); }
        .table td, .table th { text-align: center; vertical-align: middle; }
        .jugador-columna { text-align: left !important; }
        .imagen-jugador { width: 30px; height: 30px; vertical-align: middle; display: inline-block; margin-right: 8px; border-radius: 50%; object-fit: cover; }
        .small-text-stats { font-size: 0.8em; color: #6c757d; }
        .dark-mode .small-text-stats { color: #adb5bd; }
        .win-rate-alto { color: #228B22 !important; }
        .win-rate-bajo { color: tomato !important; }
        .dark-mode .win-rate-bajo { color: #ff6b6b !important; }
        #statsTable th[data-sortable="true"] { cursor: pointer; }
        #statsTable th[data-sortable="true"]::after { content: ' \2195'; opacity: 0.4; }
        #statsTable th.th-sort-asc::after { content: ' \25B2'; opacity: 1; }
        #statsTable th.th-sort-desc::after { content: ' \25BC'; opacity: 1; }
        .card-title i { margin-right: 8px; }
        .btn-group .btn.active {
            background-color: #0d6efd;
            color: white;
        }
        .dark-mode .form-select,
        .dark-mode .form-control {
            background-color: #495057 !important;
            color: #fff !important;
            border-color: #6c757d !important;
        }
        .dark-mode .form-select option {
            background-color: #343a40;
            color: #fff;
        }
        .dark-mode .list-group-item {
            background-color: #495057 !important;
            color: #fff !important;
            border-color: #6c757d !important;
        }
        .dark-mode label {
            color: #e0e0e0;
        }
        .dark-mode .btn-primary {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .dark-mode .btn-primary:hover {
            background-color: #003d82;
            border-color: #003d82;
        }
        .dark-mode a {
            color: #66b3ff;
        }
        .dark-mode a:hover {
            color: #99ccff;
        }
        .dark-mode .badge {
            background-color: #0056b3 !important;
        }
        .dark-mode .text-muted {
            color: #adb5bd !important;
        }
        .dark-mode .table thead th {
            background-color: #495057 !important;
            color: #fff !important;
        }
        .dark-mode .table tbody td {
            border-color: #6c757d !important;
        }
        .dark-mode h1, .dark-mode h2, .dark-mode h3, .dark-mode h4, .dark-mode h5 {
            color: #fff;
        }
        .dark-mode .card-header {
            background-color: #495057 !important;
            color: #fff !important;
        }
        .dark-mode .card-body {
            background-color: #343a40 !important;
        }
    </style>
</head>
<body>

<audio id="backgroundAudio" loop>
    <source src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/backgroundMusic.mp3" type="audio/mpeg">
    Tu navegador no soporta el elemento audio.
</audio>

<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/Icono2.jpg" alt="Logo" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;">
            Cerditos y Valientes
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('main.index') }}">Inicio</a>

                </li>
                {# <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('h2h') }}">Comparador</a>
                </li> #}
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="{{ url_for('stats.estadisticas_globales') }}">Estadísticas Globales</a>

                </li>
                
                
            </ul>
            <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center">
                <button id="toggle-mode" class="btn btn-secondary w-100 w-lg-auto mb-2 mb-lg-0">Modo Oscuro</button>
                <div class="d-flex align-items-center ms-lg-2">
                    <button id="toggleAudio" class="btn btn-secondary" title="Desmutear Música">
                        <i id="muteIcon" class="fas fa-microphone-slash"></i>
                    </button>
                    <input id="volumeSlider" type="range" class="form-range" min="0" max="1" step="0.01" value="1" style="width: 100px; margin-left: 10px;">
                </div>
            </div>
        </div>
    </div>
</nav>

<div class="container mt-5 pt-5">
    <h1 class="text-center mb-4">Estadísticas Globales de la Temporada</h1>
    
    <!-- Botón de actualización y estado -->
    <div class="text-center mb-4">
        <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
            <form action="{{ url_for('stats.actualizar_estadisticas') }}" method="post" class="m-0">
                <button type="submit" class="btn btn-warning btn-lg">
                    <i class="fas fa-sync-alt me-2"></i>Actualizar Estadísticas
                </button>
            </form>
            {% if last_updated %}
            <span class="text-muted">
                <i class="fas fa-clock me-1"></i>Última actualización: {{ last_updated }}
            </span>
            {% endif %}
        </div>
        {% if needs_update %}
        <div class="alert alert-info mt-3" role="alert">
            <i class="fas fa-info-circle me-2"></i>No hay estadísticas globales calculadas. 
            Haz clic en "Actualizar Estadísticas" para generarlas.
        </div>
        {% endif %}
    </div>

    <div class="text-center mb-4">
        <form action="{{ url_for('stats.estadisticas_globales') }}" method="get" class="row justify-content-center align-items-center g-2">


            <div class="col-md-3">
                <label for="queue" class="visually-hidden">Cola</label>
                <select name="queue" id="queue" class="form-select">
                    <option value="all" {% if current_queue == 'all' %}selected{% endif %}>Todas las Colas</option>
                    {% for queue in available_queues %}
                    <option value="{{ queue.id }}" {% if queue.id|string == current_queue %}selected{% endif %}>{{ queue.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="champion" class="visually-hidden">Campeón</label>
                <select name="champion" id="champion" class="form-select">
                    <option value="all">Todos los campeones</option>
                    {% for champion in champion_list %}
                    <option value="{{ champion }}" {% if champion == selected_champion %}selected{% endif %}>{{ champion }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Filtrar</button>
            </div>
        </form>
    </div>

    <ul class="nav nav-tabs" id="statsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="global-stats-tab" data-bs-toggle="tab" data-bs-target="#global-stats" type="button" role="tab" aria-controls="global-stats" aria-selected="true">Récords Globales</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="personal-records-tab" data-bs-toggle="tab" data-bs-target="#personal-records" type="button" role="tab" aria-controls="personal-records" aria-selected="false">Récords Personales</button>
        </li>
    </ul>

    <div class="tab-content" id="statsTabsContent">
        <div class="tab-pane fade" id="personal-records" role="tabpanel" aria-labelledby="personal-records-tab">
            <div class="row mt-3">
                <div class="col-md-3">
                    <label for="playerSelect" class="form-label">Seleccionar Jugador:</label>
                    <select class="form-select" id="playerSelect">
                        <option value="">-- Selecciona un jugador --</option>
                        {# Options will be populated by JavaScript #}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="accountSelect" class="form-label">Seleccionar Cuenta:</label>
                    <select class="form-select" id="accountSelect" disabled>
                        <option value="">-- Selecciona una cuenta --</option>
                        {# Options will be populated by JavaScript #}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="championSelect" class="form-label">Filtrar por Campeón:</label>
                    <select class="form-select" id="championSelect" disabled>
                        <option value="all">-- Todos los campeones --</option>
                        {# Options will be populated by JavaScript #}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="queueSelect" class="form-label">Filtrar por Cola:</label>
                    <select class="form-select" id="queueSelect" disabled>
                        <option value="all">Todas las Colas</option>
                        {% for queue in available_queues %}
                        <option value="{{ queue.id }}">{{ queue.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="d-grid gap-2 mt-3">
                <button class="btn btn-primary" id="showPersonalRecordsBtn" disabled>Mostrar Récords Personales</button>
            </div>
            <div id="personalRecordsDisplay" class="row mt-4">
                {# Personal records will be displayed here #}
            </div>
        </div>
        <div class="tab-pane fade show active" id="global-stats" role="tabpanel" aria-labelledby="global-stats-tab">
            <div class="row mb-4">
                <!-- Global Stats Summary -->
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title"><i class="fas fa-chart-pie"></i>Win Rate Global</h5>
                            <p class="card-text fs-4 {% if global_stats.overall_win_rate >= 50 %}text-success{% else %}text-danger{% endif %}">
                                {{ '%.2f' % global_stats.overall_win_rate }}%
                            </p>
                            <small class="text-muted">({{ global_stats.total_games | thousands_separator }} partidas en total)</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title text-center"><i class="fas fa-chess-queen"></i>Campeones Más Jugados</h5>
                            <ul class="list-group list-group-flush">
                                {% for champion, count in global_stats.most_played_champions %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ champion }}.png" alt="{{ champion }}" class="imagen-jugador">
                                        {{ champion }}
                                    </span>
                                    <span class="badge bg-primary rounded-pill">{{ count | thousands_separator }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                 <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title"><i class="fas fa-bolt"></i>Mayor Multikill</h5>
                            <p class="card-text fs-4">
                                {% if global_stats.global_records.largest_multikill.value == 5 %}PENTAKILL{% elif global_stats.global_records.largest_multikill.value == 4 %}Quadra Kill{% elif global_stats.global_records.largest_multikill.value == 3 %}Triple Kill{% elif global_stats.global_records.largest_multikill.value == 2 %}Double Kill{% else %}Ninguno{% endif %}
                            </p>
                            <small class="text-muted">
                                Jugador: {{ global_stats.global_records.largest_multikill.player }} ({{ global_stats.global_records.largest_multikill.riot_id }})<br>
                                {% if global_stats.global_records.largest_multikill.champion_id and global_stats.global_records.largest_multikill.champion_id != 'N/A' and global_stats.global_records.largest_multikill.champion_name and global_stats.global_records.largest_multikill.champion_name != 'N/A' %}
                                    <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ global_stats.global_records.largest_multikill.champion_name }}.png" alt="{{ global_stats.global_records.largest_multikill.champion_name }}" class="imagen-jugador">
                                    {{ global_stats.global_records.largest_multikill.champion_name }}<br>
                                {% elif global_stats.global_records.largest_multikill.champion_id and global_stats.global_records.largest_multikill.champion_id != 'N/A' %}
                                    ID Campeón: {{ global_stats.global_records.largest_multikill.champion_id | thousands_separator }}<br>
                                {% else %}
                                    Campeón: N/A<br>
                                {% endif %}
                                KDA: {{ global_stats.global_records.largest_multikill.kills | thousands_separator }}/{{ global_stats.global_records.largest_multikill.deaths | thousands_separator }}/{{ global_stats.global_records.largest_multikill.assists | thousands_separator }} ({{ '%.2f' % global_stats.global_records.largest_multikill.kda }})<br>
                                Fecha: {{ global_stats.global_records.largest_multikill.game_date | format_timestamp }}
                                {% if global_stats.global_records.largest_multikill.value > 0 and global_stats.global_records.largest_multikill.game_date > 0 and global_stats.global_records.largest_multikill.is_tied_record %} <br> <span class="badge bg-info">¡Primero en lograrlo!</span> {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Individual Record Cards -->
                {% set records = global_stats.global_records %}
                {% for key, record in records.items() %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                {% if key == 'longest_game' %}<i class="fas fa-clock"></i>Partida Más Larga
                                {% elif key == 'most_kills' %}<i class="fas fa-crosshairs"></i>Más Kills
                                {% elif key == 'most_deaths' %}<i class="fas fa-skull"></i>Más Muertes
                                {% elif key == 'most_assists' %}<i class="fas fa-hands-helping"></i>Más Asistencias
                                {% elif key == 'highest_kda' %}<i class="fas fa-star"></i>KDA Más Alto
                                {% elif key == 'most_cs' %}<i class="fas fa-coins"></i>Más CS
                                {% elif key == 'most_damage_dealt' %}<i class="fas fa-bomb"></i>Más Daño a Campeones
                                {% elif key == 'most_gold_earned' %}<i class="fas fa-sack-dollar"></i>Más Oro Ganado
                                {% elif key == 'most_vision_score' %}<i class="fas fa-eye"></i>Más Puntuación de Visión
                                {% elif key == 'largest_killing_spree' %}<i class="fas fa-fire"></i>Mayor Racha de Asesinatos
                                {% elif key == 'largest_multikill' %}<i class="fas fa-bolt"></i>Mayor Multikill
                                {% elif key == 'most_time_spent_dead' %}<i class="fas fa-bed"></i>Más Tiempo Muerto
                                {% elif key == 'most_wards_placed' %}<i class="fas fa-map-pin"></i>Más Wards Colocados
                                {% elif key == 'most_wards_killed' %}<i class="fas fa-broom"></i>Más Wards Destruidos
                                {% elif key == 'most_turret_kills' %}<i class="fas fa-chess-rook"></i>Más Torretas Destruidas
                                {% elif key == 'most_inhibitor_kills' %}<i class="fas fa-building-shield"></i>Más Inhibidores Destruidos
                                {% elif key == 'most_baron_kills' %}<i class="fas fa-dragon" style="color: #a970ff;"></i>Más Barons Asesinados
                                {% elif key == 'most_dragon_kills' %}<i class="fas fa-dragon" style="color: #ff4747;"></i>Más Dragones Asesinados
                                {% elif key == 'most_damage_taken' %}<i class="fas fa-shield-halved"></i>Más Daño Recibido
                                {% elif key == 'most_total_heal' %}<i class="fas fa-heart-pulse"></i>Más Curación Total
                                {% elif key == 'most_damage_shielded_on_teammates' %}<i class="fas fa-user-shield"></i>Más Escudo a Aliados
                                {% elif key == 'most_time_ccing_others' %}<i class="fas fa-hourglass-half"></i>Más Tiempo de CC
                                {% elif key == 'most_objectives_stolen' %}<i class="fas fa-hand-lizard"></i>Más Objetivos Robados
                                {% elif key == 'highest_kill_participation' %}<i class="fas fa-people-group"></i>Mayor Participación en Kills
                                {% elif key == 'most_double_kills' %}<i class="fas fa-2"></i>Más Asesinatos Dobles
                                {% elif key == 'most_triple_kills' %}<i class="fas fa-3"></i>Más Asesinatos Triples
                                {% elif key == 'most_quadra_kills' %}<i class="fas fa-4"></i>Más Asesinatos Cuádruples
                                {% elif key == 'most_penta_kills' %}<i class="fas fa-5"></i>Más Asesinatos Quíntuples
                                {% elif key == 'longest_win_streak' %}<i class="fas fa-arrow-trend-up"></i>Mayor Racha de Victorias
                                {% elif key == 'longest_loss_streak' %}<i class="fas fa-arrow-trend-down"></i>Mayor Racha de Derrotas
                                {% endif %}
                            </h5>
                            <p class="card-text fs-4">
                                {% if record.value is none %}N/A
                                {% elif key in ['longest_game', 'most_time_spent_dead', 'most_time_ccing_others'] %}
                                    {{ (record.value / 60) | int }}m {{ (record.value % 60) | int }}s
                                {# Apply formatting for percentage/KDA records #}
                                {% elif key in ['highest_kda', 'highest_kill_participation'] %}
                                    {{ '%.2f' % record.value }}{% if key == 'highest_kill_participation' %}%{% endif %}
                                {# Handle multikill display #}
                                {% elif key == 'largest_multikill' %}
                                     {% if record.value == 5 %}PENTAKILL{% elif record.value == 4 %}Quadra Kill{% elif record.value == 3 %}Triple Kill{% elif record.value == 2 %}Double Kill{% else %}Individual{% endif %}
                                {# For all other records, apply the thousands_separator filter #}
                                {% else %}
                                    {{ record.value | thousands_separator }}
                                {% endif %}
                            </p>
                            <small class="text-muted">
                                Jugador: {{ record.player }} ({{ record.riot_id }})<br>
                                {% if record.champion_id and record.champion_id != 'N/A' and record.champion_name and record.champion_name != 'N/A' %}
                                    <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ record.champion_name }}.png" alt="{{ record.champion_name }}" class="imagen-jugador">
                                    {{ record.champion_name }}<br>
                                {% elif record.champion_id and record.champion_id != 'N/A' %}
                                    ID Campeón: {{ record.champion_id | thousands_separator }}<br>
                                {% else %}
                                    Campeón: N/A<br>
                                {% endif %}
                                KDA: {{ record.kills | thousands_separator }}/{{ record.deaths | thousands_separator }}/{{ record.assists | thousands_separator }} ({{ '%.2f' % record.kda }})<br>
                                Fecha: {{ record.game_date | format_timestamp }}<br>
                                Duración: {{ (record.game_duration / 60) | int }}m {{ (record.game_duration % 60) | int }}s
                                {% if record.value > 0 and record.game_date > 0 and record.is_tied_record %} <br> <span class="badge bg-info">¡Primero en lograrlo!</span> {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleModeBtn = document.getElementById('toggle-mode');
        const body = document.body;

        // Soporte para dos claves de localStorage usadas en distintas plantillas:
        // - 'darkMode' === 'enabled' (usado en index.html)
        // - 'theme' === 'dark' (usado en otras partes)
        const savedDarkMode = localStorage.getItem('darkMode') === 'enabled';
        const savedThemeDark = localStorage.getItem('theme') === 'dark';
        const shouldBeDark = savedDarkMode || savedThemeDark;

        if (shouldBeDark) {
            body.classList.add('dark-mode');
            toggleModeBtn.textContent = 'Modo Claro';
        } else {
            toggleModeBtn.textContent = 'Modo Oscuro';
        }

        toggleModeBtn.addEventListener('click', function() {
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            // Actualizar texto y mantener ambas claves en sincronía para todas las páginas
            toggleModeBtn.textContent = isDark ? 'Modo Claro' : 'Modo Oscuro';
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        const audio = document.getElementById('backgroundAudio');
        const toggleAudioBtn = document.getElementById('toggleAudio');
        const muteIcon = document.getElementById('muteIcon');
        const volumeSlider = document.getElementById('volumeSlider');

        // Restore audio state from localStorage
        const isMuted = localStorage.getItem('audioMuted') === 'true';
        audio.muted = isMuted;
        muteIcon.className = isMuted ? 'fas fa-microphone-slash' : 'fas fa-microphone';
        toggleAudioBtn.title = isMuted ? 'Desmutear Música' : 'Mutear Música';

        const savedVolume = localStorage.getItem('audioVolume');
        if (savedVolume !== null) {
            audio.volume = savedVolume;
            volumeSlider.value = savedVolume;
        } else {
            audio.volume = 1; // Default volume
            volumeSlider.value = 1;
        }


        toggleAudioBtn.addEventListener('click', function() {
            audio.muted = !audio.muted;
            localStorage.setItem('audioMuted', audio.muted);
            if (audio.muted) {
                muteIcon.className = 'fas fa-microphone-slash';
                toggleAudioBtn.title = 'Mutear Música';
            } else {
                muteIcon.className = 'fas fa-microphone';
                toggleAudioBtn.title = 'Desmutear Música';
                audio.play().catch(e => console.log("La reproducción automática fue bloqueada por el navegador."));
            }
        });

        volumeSlider.addEventListener('input', function() {
            audio.volume = this.value;
            localStorage.setItem('audioVolume', this.value);
        });

        // --- Personal Records Tab Logic ---
        const playerSelect = document.getElementById('playerSelect');
        const accountSelect = document.getElementById('accountSelect');
        const championSelect = document.getElementById('championSelect');
        const queueSelect = document.getElementById('queueSelect');
        const showPersonalRecordsBtn = document.getElementById('showPersonalRecordsBtn');
        const personalRecordsDisplay = document.getElementById('personalRecordsDisplay');

        let allPlayersData = {}; // To store players and their accounts/PUUIDs

        // Function to fetch players and accounts
        async function fetchPlayersAndAccounts() {
            try {
                const response = await fetch('/api/players_and_accounts');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allPlayersData = await response.json();
                
                // Populate playerSelect dropdown
                for (const playerName in allPlayersData) {
                    const option = document.createElement('option');
                    option.value = playerName;
                    option.textContent = playerName;
                    playerSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error fetching players and accounts:', error);
                personalRecordsDisplay.innerHTML = '<p class="text-danger">Error al cargar la lista de jugadores.</p>';
            }
        }

        // Function to populate accountSelect based on player selection
        playerSelect.addEventListener('change', function() {
            accountSelect.innerHTML = '<option value="">-- Selecciona una cuenta --</option>'; // Clear previous options
            championSelect.innerHTML = '<option value="all">-- Todos los campeones --</option>'; // Reset champion select
            accountSelect.disabled = true;
            championSelect.disabled = true;
            queueSelect.disabled = true;
            showPersonalRecordsBtn.disabled = true;
            personalRecordsDisplay.innerHTML = ''; // Clear displayed records

            const selectedPlayerName = playerSelect.value;
            if (selectedPlayerName && allPlayersData[selectedPlayerName]) {
                allPlayersData[selectedPlayerName].forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.puuid; // Use PUUID as value
                    option.textContent = account.riot_id; // Display Riot ID
                    accountSelect.appendChild(option);
                });
                accountSelect.disabled = false;
            }
        });

        // Function to fetch and populate championSelect
        async function fetchPlayerChampions(puuid) {
            championSelect.innerHTML = '<option value="all">-- Todos los campeones --</option>'; // Reset
            championSelect.disabled = true;

            if (!puuid) return;

            try {
                const response = await fetch(`/api/player/${puuid}/champions`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const champions = await response.json();
                champions.forEach(champion => {
                    const option = document.createElement('option');
                    option.value = champion;
                    option.textContent = champion;
                    championSelect.appendChild(option);
                });
                championSelect.disabled = false;
            } catch (error) {
                console.error('Error fetching player champions:', error);
            }
        }

        // Enable show button and fetch champions when an account is selected
        accountSelect.addEventListener('change', function() {
            const selectedPuuid = accountSelect.value;
            showPersonalRecordsBtn.disabled = !selectedPuuid;
            queueSelect.disabled = !selectedPuuid;
            personalRecordsDisplay.innerHTML = ''; // Clear displayed records
            fetchPlayerChampions(selectedPuuid);
        });

        // Function to fetch and display personal records
        showPersonalRecordsBtn.addEventListener('click', async function() {
            const selectedPuuid = accountSelect.value;
            const selectedChampion = championSelect.value;
            const selectedQueue = queueSelect.value;

            if (!selectedPuuid) {
                personalRecordsDisplay.innerHTML = '<p class="text-warning">Por favor, selecciona una cuenta.</p>';
                return;
            }

            personalRecordsDisplay.innerHTML = '<p class="text-info">Cargando récords personales...</p>';
            
            let url = `/api/personal_records/${selectedPuuid}`;
            const params = new URLSearchParams();
            
            if (selectedChampion && selectedChampion !== 'all') {
                params.append('champion', selectedChampion);
            }
            if (selectedQueue && selectedQueue !== 'all') {
                params.append('queue', selectedQueue);
            }

            if (params.toString()) {
                url += `?${params.toString()}`;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const records = await response.json();
                displayPersonalRecords(records);
            } catch (error) {
                console.error('Error fetching personal records:', error);
                personalRecordsDisplay.innerHTML = '<p class="text-danger">Error al cargar los récords personales.</p>';
            }
        });

        // Function to display personal records
        function displayPersonalRecords(records) {
            personalRecordsDisplay.innerHTML = ''; // Clear previous records

            if (records.length === 0) {
                personalRecordsDisplay.innerHTML = '<p class="text-muted">No se encontraron récords personales para esta cuenta en la temporada actual.</p>';
                return;
            }

            records.forEach(record => {
                let valueDisplay = record.value;
                let iconClass = '';
                let titleText = '';

                // Helper function for thousands separator
                function formatNumberWithThousandsSeparator(num) {
                    if (num === null || num === undefined) return 'N/A';
                    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                }

                // Determine icon and format value based on record_type_key
                switch (record.record_type_key) {
                    case 'longest_game':
                        const minutes = Math.floor(record.value / 60);
                        const seconds = record.value % 60;
                        valueDisplay = `${minutes}m ${seconds}s`;
                        iconClass = 'fas fa-clock';
                        titleText = 'Partida Más Larga';
                        break;
                    case 'most_time_spent_dead':
                        const minutesDead = Math.floor(record.value / 60);
                        const secondsDead = record.value % 60;
                        valueDisplay = `${minutesDead}m ${secondsDead}s`;
                        iconClass = 'fas fa-bed';
                        titleText = 'Más Tiempo Muerto';
                        break;
                    case 'most_time_ccing_others':
                        const minutesCC = Math.floor(record.value / 60);
                        const secondsCC = record.value % 60;
                        valueDisplay = `${minutesCC}m ${secondsCC}s`;
                        iconClass = 'fas fa-hourglass-half';
                        titleText = 'Más Tiempo de CC';
                        break;
                    case 'highest_kda':
                        valueDisplay = record.value.toFixed(2);
                        iconClass = 'fas fa-star';
                        titleText = 'KDA Más Alto';
                        break;
                    case 'highest_kill_participation':
                        valueDisplay = record.value.toFixed(2) + '%';
                        iconClass = 'fas fa-people-group';
                        titleText = 'Mayor Participación en Kills';
                        break;
                    case 'largest_multikill':
                        if (record.value === 5) {
                            valueDisplay = 'PENTAKILL';
                        } else if (record.value === 4) {
                            valueDisplay = 'Quadra Kill';
                        } else if (record.value === 3) {
                            valueDisplay = 'Triple Kill';
                        } else if (record.value === 2) {
                            valueDisplay = 'Double Kill';
                        } else {
                            valueDisplay = 'Individual';
                        }
                        iconClass = 'fas fa-bolt';
                        titleText = 'Mayor Multikill';
                        break;
                    case 'most_kills': iconClass = 'fas fa-crosshairs'; titleText = 'Más Kills'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_deaths': iconClass = 'fas fa-skull'; titleText = 'Más Muertes'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_assists': iconClass = 'fas fa-hands-helping'; titleText = 'Más Asistencias'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_cs': iconClass = 'fas fa-coins'; titleText = 'Más CS'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_damage_dealt': iconClass = 'fas fa-bomb'; titleText = 'Más Daño a Campeones'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_gold_earned': iconClass = 'fas fa-sack-dollar'; titleText = 'Más Oro Ganado'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_vision_score': iconClass = 'fas fa-eye'; titleText = 'Más Puntuación de Visión'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'largest_killing_spree': iconClass = 'fas fa-fire'; titleText = 'Mayor Racha de Asesinatos'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_wards_placed': iconClass = 'fas fa-map-pin'; titleText = 'Más Wards Colocados'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_wards_killed': iconClass = 'fas fa-broom'; titleText = 'Más Wards Destruidos'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_turret_kills': iconClass = 'fas fa-chess-rook'; titleText = 'Más Torretas Destruidas'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_inhibitor_kills': iconClass = 'fas fa-building-shield'; titleText = 'Más Inhibidores Destruidos'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_baron_kills': iconClass = 'fas fa-dragon'; titleText = 'Más Barons Asesinados'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_dragon_kills': iconClass = 'fas fa-dragon'; titleText = 'Más Dragones Asesinados'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_damage_taken': iconClass = 'fas fa-shield-halved'; titleText = 'Más Daño Recibido'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_total_heal': iconClass = 'fas fa-heart-pulse'; titleText = 'Más Curación Total'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_damage_shielded_on_teammates': iconClass = 'fas fa-user-shield'; titleText = 'Más Escudo a Aliados'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_time_ccing_others': iconClass = 'fas fa-hourglass-half'; titleText = 'Más Tiempo de CC'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_objectives_stolen': iconClass = 'fas fa-hand-lizard'; titleText = 'Más Objetivos Robados'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_double_kills': iconClass = 'fas fa-2'; titleText = 'Más Asesinatos Dobles'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_triple_kills': iconClass = 'fas fa-3'; titleText = 'Más Asesinatos Triples'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_quadra_kills': iconClass = 'fas fa-4'; titleText = 'Más Asesinatos Cuádruples'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'most_penta_kills': iconClass = 'fas fa-5'; titleText = 'Más Asesinatos Quíntuples'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'longest_win_streak': iconClass = 'fas fa-arrow-trend-up'; titleText = 'Mayor Racha de Victorias'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    case 'longest_loss_streak': iconClass = 'fas fa-arrow-trend-down'; titleText = 'Mayor Racha de Derrotas'; valueDisplay = formatNumberWithThousandsSeparator(record.value); break;
                    default:
                        iconClass = 'fas fa-trophy';
                        titleText = record.record_type_key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Basic formatting
                        valueDisplay = formatNumberWithThousandsSeparator(record.value);
                        break;
                }

                const recordHtml = `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h5 class="card-title"><i class="${iconClass}"></i>${titleText}</h5>
                                <p class="card-text fs-4">${valueDisplay}</p>
                                <small class="text-muted">
                                    Jugador: ${record.player} (${record.riot_id})<br>
                                    ${record.champion_name && record.champion_name !== 'N/A' ? 
                                        `<img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/${record.champion_name}.png" alt="${record.champion_name}" class="imagen-jugador">
                                        ${record.champion_name}<br>` : 'Campeón: N/A<br>'}
                                    KDA: ${record.kills}/${record.deaths}/${record.assists} (${record.kda.toFixed(2)})<br>
                                    Fecha: ${new Date(record.game_date).toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}<br>
                                    Duración: ${Math.floor(record.game_duration / 60)}m ${record.game_duration % 60}s
                                </small>
                            </div>
                        </div>
                    </div>
                `;
                personalRecordsDisplay.insertAdjacentHTML('beforeend', recordHtml);
            });
        }

        // Initial fetch
        fetchPlayersAndAccounts();
    });
</script>
</body>
</html>
