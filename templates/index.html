<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoloQ Cerditos - Datos de Jugadores</title> <!-- Título genérico para la página principal -->
    <link rel="icon" href="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/Icono.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/style.css">
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        .banner-img {
            margin-top: 40px;
            width: 100%;
            max-height: 600px;
            object-fit: contain;
        }
        .small-text {
            font-size: 0.6em;
            font-weight: normal;
        }
        .small-text-stats {
            font-size: 0.8em;
            color: #6c757d;
        }
        .win-rate-alto {
            color: #228B22 !important;
        }
        .win-rate-bajo {
            color: tomato !important;
        }
        .peak-elo {
            color: gold;
            font-weight: bold;
        }
        .estado-en-partida {
            color: #007BFF !important;
            font-weight: bold;
        }
        .table a {
            color: inherit;
            text-decoration: none;
        }
        .link-estado {
            color: #007BFF;
        }
        .link-perfil:hover, .link-estado:hover {
            text-decoration: underline;
        }
        .opgg-link {
            display: inline-block;
            padding: 5px 10px;
            font-size: 0.9em;
            font-weight: bold;
            color: white !important;
            background-color: #0056b3; /* Un azul estándar */
            border-radius: 5px;
            text-decoration: none;
            transition: background-color 0.2s ease-in-out;
        }
        .opgg-link:hover {
            background-color: #004494; /* Un azul más oscuro al pasar el ratón */
        }
        .dark-mode {
            background-color: #121212;
            color: #ffffff;
        }
        .dark-mode .navbar {
            background-color: #343a40 !important;
            color: white;
        }
        .dark-mode .navbar-brand {
            color: white !important;
        }
        .dark-mode .table, .dark-mode .card {
            background-color: #343a40 !important;
            color: white;
        }
        .dark-mode .nav-link {
            color: white !important;
        }
        .dark-mode .navbar-toggler-icon {
            filter: invert(1) grayscale(100%) brightness(2);
        }
        .table td, .table th {
            text-align: center;
            vertical-align: middle;
        }
        .jugador-columna {
            text-align: left;
        }
        .hidden {
            display: none;
        }
        .imagen-jugador {
            width: 30px;
            height: 30px;
            vertical-align: middle;
            display: inline-block;
            margin-right: 8px;
            border-radius: 50%;
            object-fit: cover;
        }
        .lateral-img {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 150px;
            height: auto;
            object-fit: cover;
            display: none; /* Ocultas por defecto para evitar superposiciones */
        }
        @media (min-width: 1500px) {
            .lateral-img {
                display: block;
            }
        }
        .left-img {
            left: 20px;
        }
        .right-img {
            right: 20px;
        }
        #volumeSlider {
            width: 100px;
            margin-left: 10px;
            vertical-align: middle;
            height: 20px;
            padding: 0;
        }
        #volumeSlider::-webkit-slider-runnable-track {
            background: #6c757d;
            height: 0.2em;
            border-radius: 1em;
        }
        #volumeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: #333;
            border-radius: 50%;
            margin-top: -6.5px;
        }
        #volumeSlider::-moz-range-track {
            background: #6c757d;
            height: 0.2em;
            border-radius: 1em;
        }
        #volumeSlider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: #333;
            border: none;
            border-radius: 50px;
        }
        .dark-mode #volumeSlider::-webkit-slider-runnable-track,
        .dark-mode #volumeSlider::-moz-range-track {
            background: #495057;
        }
        .dark-mode #volumeSlider::-webkit-slider-thumb {
            background: #fff;
        }
        .dark-mode #volumeSlider::-moz-range-thumb {
            background: #fff;
        }
        #toggle-mode {
            font-weight: bold;
        }
        .table-responsive {
            margin-top: 20px;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.1);
            cursor: pointer;
        }
        .dark-mode .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.2);
        }
        .sortable-header {
            cursor: pointer;
            position: relative;
        }
        .sortable-header .sort-icon {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            color: #6c757d;
        }
        .sortable-header.asc .sort-icon::after {
            content: " \25B2"; /* Up arrow */
        }
        .sortable-header.desc .sort-icon::after {
            content: " \25BC"; /* Down arrow */
        }
        .filter-section {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-section label {
            margin-right: 5px;
            font-weight: bold;
        }
        .filter-section select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>

    <img id="left-banner" class="lateral-img left-img" src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/1.jpg" alt="Lateral izquierda">
    <img id="right-banner" class="lateral-img right-img" src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/1.jpg" alt="Lateral derecha">

    <audio id="backgroundAudio" loop>
        <source src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/backgroundMusic.mp3" type="audio/mpeg">
        Tu navegador no soporta el elemento audio.
    </audio>

    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/Icono2.jpg" alt="Logo" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;">
                Cerditos y Valientes
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 flex-column flex-lg-row">
                    <!-- Puedes añadir más enlaces de navegación aquí si es necesario -->
                </ul>
                <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center">
                    <button id="toggle-mode" class="btn btn-secondary w-100 w-lg-auto mb-2 mb-lg-0">Modo Oscuro</button>
                    <div class="d-flex align-items-center ms-lg-2">
                        <button id="toggleAudio" class="btn btn-secondary" title="Desmutear Música">
                            <i id="muteIcon" class="fas fa-microphone-slash"></i>
                        </button>
                        <input id="volumeSlider" type="range" class="form-range" min="0" max="1" step="0.01" value="1">
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container my-4 d-flex justify-content-center">
        <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/refs/heads/main/banners/Banner5.png" alt="Banner" class="banner-img" id="banner-img">
    </div>

    <div class="container mt-5">
        <h1 class="text-center mb-4">Datos de Jugadores </h1>
        <p class="text-center text-muted">Última actualización: {{ ultima_actualizacion }}</p>

        <div class="filter-section">
            <div class="form-group">
                <label for="filtroCola">Filtrar por Cola:</label>
                <select id="filtroCola" class="form-select">
                    <option value="all">Todas</option>
                    <option value="RANKED_SOLO_5x5">Solo/Duo</option>
                    <option value="RANKED_FLEX_SR">Flexible</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filtroJugador">Filtrar por Jugador:</label>
                <input type="text" id="filtroJugador" class="form-control" placeholder="Buscar por nombre de jugador o Riot ID">
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-striped table-hover rounded">
                <thead>
                    <tr>
                        <th class="sortable-header" data-sort-by="jugador">Jugador <span class="sort-icon"></span></th>
                        <th class="sortable-header" data-sort-by="game_name">Riot ID <span class="sort-icon"></span></th>
                        <th class="sortable-header" data-sort-by="queue_type">Cola <span class="sort-icon"></span></th>
                        <th class="sortable-header" data-sort-by="tier">Elo <span class="sort-icon"></span></th>
                        <th class="sortable-header" data-sort-by="league_points">LPs <span class="sort-icon"></span></th>
                        <th class="sortable-header" data-sort-by="wins">Victorias <span class="sort-icon"></span></th>
                        <th class="sortable-header" data-sort-by="losses">Derrotas <span class="sort-icon"></span></th>
                        <th>Win Rate</th>
                        <th>Peak Elo</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="tablaJugadores">
                    {% for jugador in datos_jugadores %}
                    <tr data-queue-type="{{ jugador.queue_type }}" data-jugador-nombre="{{ jugador.jugador | lower }}" data-game-name="{{ jugador.game_name | lower }}" onclick="window.location.href='{{ url_for('perfil_jugador', game_name=jugador.game_name) }}'">
                        <td class="jugador-columna">
                            <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/img_perfil/{{ jugador.jugador }}.png"
                                 alt="Icono de {{ jugador.jugador }}" class="imagen-jugador"
                                 onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'><circle cx=\'50\' cy=\'50\' r=\'50\' fill=\'white\'/></svg>';">
                            {{ jugador.jugador }}
                        </td>
                        <td>{{ jugador.game_name }}</td>
                        <td>{{ jugador.queue_type | replace('_SR', '') | replace('_5x5', '') | replace('RANKED_', '') }}</td>
                        <td>
                            <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/logos_elo/{{ jugador.tier }}.png"
                                 alt="{{ jugador.tier }}" style="width: 20px; height: 20px; vertical-align: middle;">
                            {{ jugador.tier }} {{ jugador.rank }}
                        </td>
                        <td>{{ jugador.league_points }}</td>
                        <td>{{ jugador.wins }}</td>
                        <td>{{ jugador.losses }}</td>
                        {% set total_games = jugador.wins + jugador.losses %}
                        {% set win_rate = (jugador.wins / total_games * 100) if total_games > 0 else 0 %}
                        <td class="{% if win_rate >= 50 %}win-rate-alto{% else %}win-rate-bajo{% endif %}">
                            {{ '%.2f'|format(win_rate) }}%
                        </td>
                        <td class="peak-elo">
                            {% if jugador.valor_clasificacion == jugador.peak_elo %}
                                PEAK
                            {% else %}
                                {{ jugador.peak_elo }}
                            {% endif %}
                        </td>
                        <td>
                            {% if jugador.en_partida %}
                                <a href="{{ jugador.url_ingame }}" target="_blank" class="link-estado estado-en-partida">
                                    En partida ({{ jugador.nombre_campeon }})
                                </a>
                            {% else %}
                                Fuera de partida
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Script de Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const audio = document.getElementById('backgroundAudio');
            const toggleAudioButton = document.getElementById('toggleAudio');
            const volumeSlider = document.getElementById('volumeSlider');
            const muteIcon = document.getElementById('muteIcon');

            // Inicialmente silenciar el audio para cumplir con políticas de autoplay
            audio.muted = true;
            // El navegador puede bloquear el autoplay, el audio se iniciará con la interacción del usuario.
            audio.play().catch(error => console.log('La reproducción automática de audio fue bloqueada por el navegador.', error));

            const playAudio = () => {
                if (audio.paused) {
                    audio.play().catch(e => console.log("El usuario debe interactuar con la página para reproducir audio.", e));
                }
            };

            volumeSlider.addEventListener('input', function() {
                playAudio();
                audio.volume = this.value;
            });

            toggleAudioButton.addEventListener('click', () => {
                playAudio();
                audio.muted = !audio.muted;
                if (audio.muted) {
                    muteIcon.className = 'fas fa-microphone-slash';
                    toggleAudioButton.title = 'Desmutear Música';
                } else {
                    muteIcon.className = 'fas fa-microphone-alt';
                    toggleAudioButton.title = 'Silenciar Música';
                }
            });

            const toggleModeButton = document.getElementById("toggle-mode");
            toggleModeButton.addEventListener("click", () => {
                document.body.classList.toggle("dark-mode");
                // Guardar la preferencia del modo oscuro en localStorage
                if (document.body.classList.contains("dark-mode")) {
                    localStorage.setItem('theme', 'dark');
                } else {
                    localStorage.setItem('theme', 'light');
                }
            });

            // Aplicar el modo oscuro si estaba guardado en localStorage
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
            }

            const leftBanner = document.getElementById("left-banner");
            const rightBanner = document.getElementById("right-banner");
            const imagePaths = [
                "https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/1.jpg",
                "https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/2.jpg",
                "https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/3.jpg",
                "https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/4.jpg",
                "https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/5.jpg"
            ];
            let currentImageIndex = 0;

            function cambiarImagenes() {
                currentImageIndex = (currentImageIndex + 1) % imagePaths.length;
                leftBanner.src = imagePaths[currentImageIndex];
                rightBanner.src = imagePaths[currentImageIndex];
            }
            setInterval(cambiarImagenes, 5000);

            // --- Funcionalidad de Filtrado y Ordenación ---
            const filtroCola = document.getElementById('filtroCola');
            const filtroJugador = document.getElementById('filtroJugador');
            const tablaJugadores = document.getElementById('tablaJugadores');
            const filas = Array.from(tablaJugadores.getElementsByTagName('tr'));

            function aplicarFiltro() {
                const colaSeleccionada = filtroCola.value;
                const textoFiltroJugador = filtroJugador.value.toLowerCase();

                filas.forEach(fila => {
                    const queueType = fila.dataset.queueType;
                    const jugadorNombre = fila.dataset.jugadorNombre;
                    const gameName = fila.dataset.gameName;

                    const coincideCola = (colaSeleccionada === 'all' || queueType === colaSeleccionada);
                    const coincideJugador = (jugadorNombre.includes(textoFiltroJugador) || gameName.includes(textoFiltroJugador));

                    if (coincideCola && coincideJugador) {
                        fila.classList.remove('hidden');
                    } else {
                        fila.classList.add('hidden');
                    }
                });
            }

            filtroCola.addEventListener('change', aplicarFiltro);
            filtroJugador.addEventListener('input', aplicarFiltro);

            // Funcionalidad de ordenación
            let currentSort = {
                column: 'valor_clasificacion', // Columna por defecto para ordenar
                direction: 'desc' // Dirección por defecto
            };

            const headers = document.querySelectorAll('.sortable-header');
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const sortBy = header.dataset.sortBy;
                    // Si se hace clic en la misma columna, invertir la dirección
                    if (currentSort.column === sortBy) {
                        currentSort.direction = (currentSort.direction === 'asc') ? 'desc' : 'asc';
                    } else {
                        // Si se hace clic en una nueva columna, establecer la dirección por defecto a 'desc'
                        currentSort.column = sortBy;
                        currentSort.direction = 'desc';
                    }
                    sortTable(currentSort.column, currentSort.direction);
                    updateSortIcons(currentSort.column, currentSort.direction);
                });
            });

            function sortTable(column, direction) {
                const tbody = document.getElementById('tablaJugadores');
                const rows = Array.from(tbody.rows);

                rows.sort((a, b) => {
                    let aValue, bValue;

                    if (column === 'jugador') {
                        aValue = a.cells[0].textContent.trim().toLowerCase();
                        bValue = b.cells[0].textContent.trim().toLowerCase();
                    } else if (column === 'game_name') {
                        aValue = a.cells[1].textContent.trim().toLowerCase();
                        bValue = b.cells[1].textContent.trim().toLowerCase();
                    } else if (column === 'queue_type') {
                        aValue = a.cells[2].textContent.trim().toLowerCase();
                        bValue = b.cells[2].textContent.trim().toLowerCase();
                    } else if (column === 'tier') {
                        // Para Elo, necesitamos un mapeo a un valor numérico para ordenar correctamente
                        const eloOrder = {
                            "CHALLENGER": 10, "GRANDMASTER": 9, "MASTER": 8,
                            "DIAMOND": 7, "EMERALD": 6, "PLATINUM": 5,
                            "GOLD": 4, "SILVER": 3, "BRONZE": 2, "IRON": 1,
                            "SIN RANGO": 0 // Manejar el caso "Sin rango"
                        };
                        const rankOrder = {"I": 4, "II": 3, "III": 2, "IV": 1, "": 0}; // Para sub-rangos

                        const aTierText = a.cells[3].textContent.trim().split(' ')[0].toUpperCase();
                        const bTierText = b.cells[3].textContent.trim().split(' ')[0].toUpperCase();
                        const aRankText = a.cells[3].textContent.trim().split(' ')[1] || "";
                        const bRankText = b.cells[3].textContent.trim().split(' ')[1] || "";

                        aValue = eloOrder[aTierText] * 100 + rankOrder[aRankText];
                        bValue = eloOrder[bTierText] * 100 + rankOrder[bRankText];

                    } else if (column === 'league_points' || column === 'wins' || column === 'losses') {
                        const cellIndex = (column === 'league_points') ? 4 : (column === 'wins' ? 5 : 6);
                        aValue = parseInt(a.cells[cellIndex].textContent.trim());
                        bValue = parseInt(b.cells[cellIndex].textContent.trim());
                    } else if (column === 'valor_clasificacion') {
                        // Este es el valor numérico calculado que ya se pasa desde Flask
                        // Necesitamos acceder a los datos originales para esto
                        // Una forma es guardar los datos_jugadores en JS y usarlos aquí
                        // Por ahora, asumimos que se puede inferir o que es un valor numérico directo
                        // Si no, necesitaríamos un data-attribute en la fila para valor_clasificacion
                        // Para este ejemplo, lo haremos con un placeholder o lo omitimos si no es trivial
                        // Para que funcione, cada <tr> debería tener un data-valor-clasificacion
                        // Por simplicidad, si no hay un data-attribute, se usará el LP como proxy
                        aValue = parseInt(a.cells[4].textContent.trim()); // Usar LPs como proxy si no hay valor_clasificacion directo
                        bValue = parseInt(b.cells[4].textContent.trim());
                    }

                    if (aValue < bValue) return direction === 'asc' ? -1 : 1;
                    if (aValue > bValue) return direction === 'asc' ? 1 : -1;
                    return 0;
                });

                rows.forEach(row => tbody.appendChild(row));
            }

            function updateSortIcons(activeColumn, activeDirection) {
                headers.forEach(header => {
                    header.classList.remove('asc', 'desc');
                    if (header.dataset.sortBy === activeColumn) {
                        header.classList.add(activeDirection);
                    }
                });
            }

            // Carga inicial con filtro y ordenación por defecto
            aplicarFiltro();
            sortTable(currentSort.column, currentSort.direction);
            updateSortIcons(currentSort.column, currentSort.direction);
        });
    </script>
</body>

</html>
