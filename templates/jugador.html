<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Jugador - {{ perfil.nombre }}</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/Icono.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/style.css">
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        .banner-img {
            margin-top: 40px;
            width: 100%;
            max-height: 600px;
            object-fit: contain;
        }
        .small-text {
            font-size: 0.6em;
            font-weight: normal;
            color: #6c757d;
        }
        .small-text-stats {
            font-size: 0.8em;
            color: #6c757d;
        }
        .win-rate-alto {
            color: #228B22 !important;
        }
        .win-rate-bajo {
            color: tomato !important;
        }
        .peak-elo {
            color: gold;
            font-weight: bold;
        }
        .estado-en-partida {
            color: #007BFF !important;
            font-weight: bold;
        }
        .table a {
            color: inherit;
            text-decoration: none;
        }
        .link-estado {
            color: #007BFF;
        }
        .link-perfil:hover, .link-estado:hover {
            text-decoration: underline;
        }
        .opgg-link {
            display: inline-block;
            padding: 5px 10px;
            font-size: 0.9em;
            font-weight: bold;
            color: white !important;
            background-color: #0056b3; /* Un azul estándar */
            border-radius: 50px; /* Changed to 50px for pill shape */
            text-decoration: none;
            transition: background-color 0.2s ease-in-out;
        }
        .opgg-link:hover {
            background-color: #004494; /* Un azul más oscuro al pasar el ratón */
        }
        .dark-mode {
            background-color: #121212;
            color: #ffffff;
        }
        .dark-mode .navbar {
            background-color: #343a40 !important;
            color: white;
        }
        .dark-mode .navbar-brand {
            color: white !important;
        }
        .dark-mode .table, .dark-mode .card {
            background-color: #343a40 !important;
            color: white;
        }
        .dark-mode .nav-link {
            color: white !important;
        }
        .dark-mode .navbar-toggler-icon {
            filter: invert(1) grayscale(100%) brightness(2);
        }
        .table td, .table th {
            text-align: center;
            vertical-align: middle;
        }
        .jugador-columna {
            text-align: left;
        }
        .hidden {
            display: none;
        }
        .imagen-jugador {
            width: 30px;
            height: 30px;
            vertical-align: middle;
            display: inline-block;
            margin-right: 8px;
            border-radius: 50%;
            object-fit: cover;
        }
        .lateral-img {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 150px;
            height: auto;
            object-fit: cover;
            display: none; /* Ocultas por defecto para evitar superposiciones */
        }
        @media (min-width: 1500px) {
            .lateral-img {
                display: block;
            }
        }
        .left-img {
            left: 20px;
        }
        .right-img {
            right: 20px;
        }

        #volumeSlider {
            width: 100px;
            margin-left: 10px;
            vertical-align: middle;
            height: 20px;
            padding: 0;
        }

        #volumeSlider::-webkit-slider-runnable-track {
            background: #6c757d;
            height: 0.2em;
            border-radius: 1em;
        }

        #volumeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: #333;
            border-radius: 50%;
            margin-top: -6.5px;
        }

        #volumeSlider::-moz-range-track {
            background: #6c757d;
            height: 0.2em;
            border-radius: 1em;
        }

        #volumeSlider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: #333;
            border: none;
            border-radius: 50px;
        }

        .dark-mode #volumeSlider::-webkit-slider-runnable-track,
        .dark-mode #volumeSlider::-moz-range-track {
            background: #495057;
        }

        .dark-mode #volumeSlider::-webkit-slider-thumb {
            background: #fff;
        }

        .dark-mode #volumeSlider::-moz-range-thumb {
            background: #fff;
        }

        #toggle-mode {
            font-weight: bold;
        }

        /* Estilos específicos para la página de jugador */
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .profile-header img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #007bff;
            margin-bottom: 15px;
        }
        .rank-card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .rank-card .card-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .rank-card .card-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .rank-card .elo-image-lg {
            width: 120px;
            height: 120px;
            object-fit: contain;
            margin-bottom: 15px;
        }
        .rank-details {
            text-align: center;
            width: 100%;
        }
        .rank-details h4 {
            margin-bottom: 5px;
            color: #007bff;
        }
        .rank-details p {
            margin-bottom: 3px;
        }
        .champion-stats-container {
            margin-top: 20px;
            width: 100%;
        }
        .champion-stats-item {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .champion-stats-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .champion-stats-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        .champion-stats-info {
            text-align: center;
        }
        .champion-stats-info h5 {
            margin-bottom: 0;
            font-size: 1.1em;
        }
        .kda-text {
            font-size: 0.9em;
            color: #6c757d;
        }
        .match-history-card {
            margin-top: 40px;
        }
        /* Styles for the new table structure */
        .match-history-table th, .match-history-table td {
            vertical-align: middle;
            padding: 8px; /* Adjust padding for table cells */
        }
        .match-history-table .champion-level-container {
            width: 60px; /* Larger champion image */
            height: 60px;
            margin: 0 auto; /* Center the champion image */
        }
        .match-history-table .champion-level {
            font-size: 0.8em; /* Slightly larger level text */
            bottom: -8px;
            right: -8px;
            padding: 3px 6px;
            min-width: 24px;
        }
        .match-history-table .summoner-spells,
        .match-history-table .runes {
            gap: 4px; /* Larger gap for spells/runes */
            margin: 0 auto; /* Center spells/runes */
        }
        .match-history-table .summoner-spells img,
        .match-history-table .runes img {
            width: 25px; /* Larger spells/runes images */
            height: 25px;
        }
        .match-history-table .kda-text {
            font-size: 1.1em; /* Larger KDA text */
            font-weight: bold;
        }
        .items-layout {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .items-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            width: calc(25px * 3 + 3px * 2); /* 3 items + 2 gaps */
        }
        .items-grid img, .items-grid .item-placeholder,
        .trinket-item img, .trinket-item .item-placeholder {
            width: 25px;
            height: 25px;
            border-radius: 5px;
        }
        .trinket-item .item-placeholder, .items-grid .item-placeholder {
            border: 1px solid rgba(108, 117, 125, 0.3);
        }
        .dark-mode .trinket-item .item-placeholder, .dark-mode .items-grid .item-placeholder {
            border: 1px solid rgba(255, 255, 255, 0.3); /* Lighter border in dark mode */
        }
        .match-history-table .match-result {
            font-size: 1.1em; /* Larger result text */
        }
        /* --- INICIO: Mejoras de visualización del historial --- */
        .match-history-table .match-row-win > td {
            background-color: rgba(40, 167, 69, 0.08);
        }
        .match-history-table .match-row-loss > td {
            background-color: rgba(220, 53, 69, 0.08);
        }
        .dark-mode .match-history-table .match-row-win > td {
            background-color: rgba(40, 167, 69, 0.15);
        }
        .dark-mode .match-history-table .match-row-loss > td {
            background-color: rgba(220, 53, 69, 0.15);
        }
        .highlight-performance {
            border-left: 4px solid #ffc107; /* Borde dorado para partidas destacadas */
        }
        .multikill-badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 0.75em;
            font-weight: bold;
            color: white;
            border-radius: 4px;
            margin-left: 5px;
            vertical-align: middle;
        }
        .penta-kill { background-color: #ff4500; } /* NaranjaRojo */
        .quadra-kill { background-color: #9400d3; } /* Violeta Oscuro */
        .triple-kill { background-color: #dc143c; } /* Carmesí */
        .double-kill { background-color: #0056b3; } /* Azul */

        .damage-bar {
            display: flex;
            width: 100%;
            min-width: 80px; /* Ancho mínimo ajustado */
            height: 12px; /* Altura reducida para una barra más fina */
            border-radius: 4px;
            overflow: hidden;
            background-color: #e9ecef;
            border: 1px solid #ccc;
        }
        .damage-physical { background-color: #ff8c00; } /* Naranja */
        .damage-magic { background-color: #4169e1; } /* Azul Royal */
        .damage-true { background-color: #f8f9fa; } /* Casi blanco */
        .dark-mode .damage-bar { background-color: #212529; border-color: #495057; }

        /* --- FIN: Mejoras de visualización del historial --- */

        /* Styles for filter controls */
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            justify-content: center; /* Center filters */
            align-items: center;
        }
        .filter-controls label {
            margin-bottom: 0; /* Remove default label margin */
            font-weight: bold;
        }
        .filter-controls select {
            flex-grow: 1; /* Allow select boxes to grow */
            max-width: 200px; /* Max width for select boxes */
        }

        /* Styles for champion level overlay */
        .champion-level-container {
            position: relative;
            display: inline-block;
        }
        .champion-level-container img {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        .champion-level {
            position: absolute;
            background-color: #343a40;
            color: white;
            font-weight: bold;
            border-radius: 50%;
            text-align: center;
            border: 1px solid #6c757d;
        }

        /* Styles for summoner spells */
        .summoner-spells {
            display: flex;
            flex-direction: column;
        }
        .summoner-spells img {
            border-radius: 3px;
        }

        /* Styles for runes */
        .runes {
            display: flex;
            flex-direction: column;
        }
        .runes img {
            border-radius: 50%;
        }
        .runes img.keystone {
            border: 1px solid gold;
        }
        .runes img.sub-rune {
            border: 1px solid #6c757d;
        }

        /* Dark mode specific text color for small-text-stats */
        .small-text-stats {
            color: #6c757d; /* Default light mode color */
        }
        .dark-mode .small-text-stats, .dark-mode .small-text {
            color: #adb5bd; /* Lighter gray for better contrast in dark mode */
        }

        /* Estilos para el desplegable de jugadores */
        .match-details-dropdown {
            display: none; /* Oculto por defecto */
            padding: 15px;
            background-color: #f8f9fa; /* Fondo claro para el desplegable */
            border-top: 1px solid #e9ecef;
            margin-top: 5px;
            border-radius: 0 0 8px 8px;
            color: #212529; /* Color de texto oscuro para el desplegable */
        }
        .dark-mode .match-details-dropdown {
            background-color: #495057; /* Fondo oscuro en modo oscuro */
            color: #f8f9fa;
            border-top: 1px solid #6c757d;
        }
        .match-details-dropdown h6 {
            margin-top: 10px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #007bff; /* Color para títulos de equipo */
        }
        .dark-mode .match-details-dropdown h6 {
            color: #ffffff;
        }
        .player-detail-table {
            width: 100%;
            margin-bottom: 15px;
            border-collapse: collapse;
        }
        .player-detail-table th, .player-detail-table td {
            padding: 5px;
            border: 1px solid #dee2e6;
            text-align: left;
            vertical-align: middle;
        }
        .dark-mode .player-detail-table th, .dark-mode .player-detail-table td {
            border: 1px solid #6c757d;
        }
        .player-detail-table th {
            background-color: #e9ecef;
            font-size: 0.85em;
        }
        .dark-mode .player-detail-table th {
            background-color: #6c757d;
        }
        .player-detail-table td {
            font-size: 0.8em;
        }
        .player-detail-table .champion-icon-small {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            vertical-align: middle;
            margin-right: 5px;
        }
        .player-detail-table .items-grid-small {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
        }
        .player-detail-table .items-grid-small img {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        .player-detail-table .item-placeholder-small {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid rgba(108, 117, 125, 0.3);
            display: inline-block;
        }
        .dark-mode .player-detail-table .item-placeholder-small {
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .toggle-details-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .toggle-details-btn:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <img id="left-banner" class="lateral-img left-img" src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/1.jpg" alt="Lateral izquierda">
    <img id="right-banner" class="lateral-img right-img" src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/1.jpg" alt="Lateral derecha">
    <audio id="backgroundAudio" loop>
        <source src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/backgroundMusic.mp3" type="audio/mpeg">
        Tu navegador no soporta el elemento audio.
    </audio>

    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/Icono2.jpg" alt="Logo" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;">
                Cerditos y Valientes
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
                aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 flex-column flex-lg-row">
                    </ul>
                <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center">
                    <button id="toggle-mode" class="btn btn-secondary w-100 w-lg-auto mb-2 mb-lg-0">Modo Oscuro</button>
                    <div class="d-flex align-items-center ms-lg-2">
                        <button id="toggleAudio" class="btn btn-secondary" title="Desmutear Música">
                            <i id="muteIcon" class="fas fa-microphone-slash"></i>
                        </button>
                        <input id="volumeSlider" type="range" class="form-range" min="0" max="1" step="0.01" value="1">
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container my-4 d-flex justify-content-center">
        <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/refs/heads/main/banners/Banner5.png" alt="Banner" class="banner-img" id="banner-img">
    </div>

    <div class="container mt-5">
        <div class="profile-header">
            <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/img_perfil/{{ perfil.nombre }}.png" alt="Imagen de {{ perfil.nombre }}" onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'><circle cx=\'50\' cy=\'50\' r=\'50\' fill=\'white\'/></svg>';">
            <h1>{{ perfil.nombre }} <span class="small-text">({{ perfil.game_name }})</span></h1>
            <a href="https://www.op.gg/summoners/euw/{{ perfil.game_name | replace('#', '-') }}" target="_blank" class="opgg-link">Ver en OP.GG</a>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card rank-card">
                    <div class="card-header">
                        Clasificatoria Solo/Duo
                    </div>
                    <div class="card-body">
                        {% if perfil.soloq %}
                        <img src="" alt="{{ perfil.soloq.tier }}" class="elo-image-lg">
                        <div class="rank-details">
                            <h4>{{ perfil.soloq.tier }} {{ perfil.soloq.rank }} ({{ perfil.soloq.league_points }} LPs)</h4>
                            <p>Wins: {{ perfil.soloq.wins }} | Losses: {{ perfil.soloq.losses }} | Total: {{ perfil.soloq.wins + perfil.soloq.losses }}</p>
                            {% set soloq_total_games = perfil.soloq.wins + perfil.soloq.losses %}
                            {% set soloq_win_rate = (perfil.soloq.wins / soloq_total_games * 100) if soloq_total_games > 0 else 0 %}
                            <p class="{% if soloq_win_rate >= 50 %}win-rate-alto{% else %}win-rate-bajo{% endif %}">
                                Win Rate: {{ '%.2f'|format(soloq_win_rate) }}%
                            </p>
                            <p>
                                Peak Elo:
                                {% set peak_elo_soloq = perfil.soloq.get('peak_elo', 0) %}
                                {% set diff_peak_soloq = perfil.soloq.valor_clasificacion - peak_elo_soloq %}
                                {% if diff_peak_soloq == 0 %}
                                <span class="peak-elo">{{ peak_elo_soloq | format_peak_elo }}</span>
                                {% else %}
                                {{ peak_elo_soloq | format_peak_elo }}
                                <span class="small-text-stats">({{ (diff_peak_soloq * -1) }} LPs por debajo)</span>
                                {% endif %}
                            </p>
                            <p>
                                Rachas (Max): <span class="text-success fw-bold">{{ perfil.soloq.max_win_streak }}W</span> / <span class="text-danger fw-bold">{{ perfil.soloq.max_loss_streak }}L</span>
                            </p>
                        </div>
                        {% else %}
                        <p>No hay datos de clasificatoria Solo/Duo disponibles.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card rank-card">
                    <div class="card-header">
                        Clasificatoria Flexible
                    </div>
                    <div class="card-body">
                        {% if perfil.flex %}
                        <img src="" alt="{{ perfil.flex.tier }}" class="elo-image-lg">
                        <div class="rank-details">
                            <h4>{{ perfil.flex.tier }} {{ perfil.flex.rank }} ({{ perfil.flex.league_points }} LPs)</h4>
                            <p>Wins: {{ perfil.flex.wins }} | Losses: {{ perfil.flex.losses }} | Total: {{ perfil.flex.wins + perfil.flex.losses }}</p>
                            {% set flex_total_games = perfil.flex.wins + perfil.flex.losses %}
                            {% set flex_win_rate = (perfil.flex.wins / flex_total_games * 100) if flex_total_games > 0 else 0 %}
                            <p class="{% if flex_win_rate >= 50 %}win-rate-alto{% else %}win-rate-bajo{% endif %}">
                                Win Rate: {{ '%.2f'|format(flex_win_rate) }}%
                            </p>
                            <p>
                                Peak Elo:
                                {% set peak_elo_flex = perfil.flex.get('peak_elo', 0) %}
                                {% set diff_peak_flex = perfil.flex.valor_clasificacion - peak_elo_flex %}
                                {% if diff_peak_flex == 0 %}
                                <span class="peak-elo">{{ peak_elo_flex | format_peak_elo }}</span>
                                {% else %}
                                {{ peak_elo_flex | format_peak_elo }}
                                <span class="small-text-stats">({{ (diff_peak_flex * -1) }} LPs por debajo)</span>
                                {% endif %}
                            </p>
                            <p>
                                Rachas (Max): <span class="text-success fw-bold">{{ perfil.flex.max_win_streak }}W</span> / <span class="text-danger fw-bold">{{ perfil.flex.max_loss_streak }}L</span>
                            </p>
                        </div>
                        {% else %}
                        <p>No hay datos de clasificatoria Flexible disponibles.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="card champion-stats-container mt-4">
            <div class="card-header">
                Estadísticas por Campeón (Temporada Actual)
            </div>
            <div class="card-body">
                {% if perfil.champion_stats %}
                {% for champion_id, stats in perfil.champion_stats.items() %}
                <div class="champion-stats-item">
                    <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ obtener_nombre_campeon(champion_id) }}.png" alt="{{ obtener_nombre_campeon(champion_id) }}">
                    <div class="champion-stats-info">
                        <h5>{{ obtener_nombre_campeon(champion_id) }}</h5>
                        <p class="kda-text">KDA: {{ '%.2f'|format(stats.kda) }} | Wins: {{ stats.wins }} | Losses: {{ stats.losses }}</p>
                        {% set total_games = stats.wins + stats.losses %}
                        {% set win_rate = (stats.wins / total_games * 100) if total_games > 0 else 0 %}
                        <p class="{% if win_rate >= 50 %}win-rate-alto{% else %}win-rate-bajo{% endif %}">
                            Win Rate: {{ '%.2f'|format(win_rate) }}%
                        </p>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p>No hay datos de estadísticas por campeón disponibles.</p>
                {% endif %}
            </div>
        </div>

        <div class="card match-history-card mt-4">
            <div class="card-header">
                Historial de Partidas
            </div>
            <div class="card-body">
                <div class="filter-controls">
                    <label for="queueFilter">Filtrar por Cola:</label>
                    <select id="queueFilter" class="form-select w-auto">
                        <option value="all">Todas las colas</option>
                        </select>

                    <label for="championFilter">Filtrar por Campeón:</label>
                    <select id="championFilter" class="form-select w-auto">
                        <option value="all">Todos los campeones</option>
                        </select>
                </div>

                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover match-history-table">
                        <thead>
                            <tr>
                                <th scope="col">Resultado</th>
                                <th scope="col">Tipo de Cola</th>
                                <th scope="col">Campeón</th>
                                <th scope="col">KDA</th>
                                <th scope="col">Objetos</th>
                                <th scope="col">Daño</th>
                                <th scope="col">CS</th>
                                <th scope="col">Oro</th>
                                <th scope="col">Visión</th>
                                <th scope="col">Tiempo</th>
                                <th scope="col">Fecha</th>
                                <th scope="col">Detalles</th> </tr>
                        </thead>
                        <tbody id="matchHistoryTableBody">
                            {% for match in perfil.historial_partidas %}
                            {% if match.match_id %}
                            <tr class="match-row match-row-{{ 'win' if match.win else 'loss' }}"
                                data-queue-id="{{ match.queue_id }}"
                                data-champion-name="{{ match.champion_name }}"
                                {% if match.largestMultiKill >= 3 %}
                                data-performance-highlight="true"
                                {% endif %}
                            >
                                <td>
                                    <span class="match-result">{{ 'VICTORIA' if match.win else 'DERROTA' }}</span>
                                    {% if match.largestMultiKill >= 2 %}
                                    <span class="multikill-badge
                                        {% if match.largestMultiKill == 5 %}penta-kill{% elif match.largestMultiKill == 4 %}quadra-kill{% elif match.largestMultiKill == 3 %}triple-kill{% elif match.largestMultiKill == 2 %}double-kill{% endif %}">
                                        {{ match.largestMultiKill }}x
                                    </span>
                                    {% endif %}
                                </td>
                                <td>{{ match.queue_id | get_queue_type }}</td>
                                <td>
                                    <div class="d-flex align-items-center justify-content-center">
                                        <div class="champion-level-container me-2">
                                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ match.champion_name }}.png" alt="{{ match.champion_name }}">
                                            <span class="champion-level">{{ match.champion_level }}</span>
                                        </div>
                                        <div class="summoner-spells me-2">
                                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/{{ match.summoner_spell_1_id }}.png" alt="Spell 1">
                                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/{{ match.summoner_spell_2_id }}.png" alt="Spell 2">
                                        </div>
                                        <div class="runes">
                                            <img src="https://ddragon.leagueoflegends.com/cdn/img/{{ match.perk_main_id }}" alt="Rune Main" class="keystone">
                                            <img src="https://ddragon.leagueoflegends.com/cdn/img/{{ match.perk_sub_id }}" alt="Rune Sub" class="sub-rune">
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="kda-text">{{ match.kills }}/{{ match.deaths }}/{{ match.assists }}</span><br>
                                    <span class="small-text-stats">KDA: {{ '%.2f'|format(match.kda) }}</span>
                                </td>
                                <td>
                                    <div class="items-layout">
                                        <div class="items-grid">
                                            {% for item_id in match.player_items[:6] %}
                                            {% if item_id != 0 %}
                                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/item/{{ item_id }}.png" alt="Item">
                                            {% else %}
                                            <span class="item-placeholder d-inline-block bg-secondary"></span>
                                            {% endif %}
                                            {% endfor %}
                                        </div>
                                        <div class="trinket-item">
                                            {% if match.player_items[6] != 0 %}
                                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/item/{{ match.player_items[6] }}.png" alt="Trinket">
                                            {% else %}
                                            <span class="item-placeholder d-inline-block bg-secondary"></span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div>{{ '{:,.0f}'.format(match.total_damage_dealt_to_champions) }}</div>
                                    <div class="small-text-stats">({{ '{:,.0f}'.format(match.total_damage_dealt) }} total)</div>
                                    <div class="damage-bar">
                                        {% set total_damage = match.physical_damage_dealt_to_champions + match.magic_damage_dealt_to_champions + match.true_damage_dealt_to_champions %}
                                        <div class="damage-physical" style="width: {{ (match.physical_damage_dealt_to_champions / total_damage * 100) if total_damage > 0 else 0 }}%;"></div>
                                        <div class="damage-magic" style="width: {{ (match.magic_damage_dealt_to_champions / total_damage * 100) if total_damage > 0 else 0 }}%;"></div>
                                        <div class="damage-true" style="width: {{ (match.true_damage_dealt_to_champions / total_damage * 100) if total_damage > 0 else 0 }}%;"></div>
                                    </div>
                                </td>
                                <td>
                                    <div>{{ match.total_minions_killed + match.neutral_minions_killed }}</div>
                                    <div class="small-text-stats">({{ '%.1f'|format((match.total_minions_killed + match.neutral_minions_killed) / (match.game_duration / 60)) }} CS/min)</div>
                                </td>
                                <td>{{ '{:,.0f}'.format(match.gold_earned) }}</td>
                                <td>
                                    <div>{{ match.vision_score }}</div>
                                    <div class="small-text-stats">({{ match.wards_placed }} P / {{ match.wards_killed }} K)</div>
                                </td>
                                <td>
                                    <div>{{ '{:02d}:{:02d}'.format(match.game_duration // 60, match.game_duration % 60) }}</div>
                                    <div class="small-text-stats">Muerte: {{ '{:02d}:{:02d}'.format(match.total_time_spent_dead // 60, match.total_time_spent_dead % 60) }}</div>
                                </td>
                                <td>{{ match.game_end_timestamp | format_timestamp }}</td>
                                <td>
                                    <button class="toggle-details-btn" data-bs-toggle="collapse" data-bs-target="#matchDetails-{{ loop.index }}" aria-expanded="false" aria-controls="matchDetails-{{ loop.index }}">
                                        Ver detalles
                                    </button>
                                </td>
                            </tr>
                            <tr class="collapse match-details-row" id="matchDetails-{{ loop.index }}">
                                <td colspan="12">
                                    <div class="match-details-dropdown">
                                        <h6>Equipo Azul (Blue Team)</h6>
                                        <table class="player-detail-table">
                                            <thead>
                                                <tr>
                                                    <th>Campeón</th>
                                                    <th>Jugador</th>
                                                    <th>KDA</th>
                                                    <th>Objetos</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for participant in match.all_participants %}
                                                {% if participant.team_id == 100 %}
                                                <tr>
                                                    <td>
                                                        <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ participant.champion_name }}.png" alt="{{ participant.champion_name }}" class="champion-icon-small">
                                                    </td>
                                                    <td>{{ participant.summoner_name }}</td>
                                                    <td>{{ participant.kills }}/{{ participant.deaths }}/{{ participant.assists }} {% if participant.win %}(Victoria){% else %}(Derrota){% endif %}</td>
                                                    <td>
                                                        <div class="items-grid-small">
                                                            {% for item_id in participant.items[:6] %}
                                                            {% if item_id != 0 %}
                                                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/item/{{ item_id }}.png" alt="Item">
                                                            {% else %}
                                                            <span class="item-placeholder-small bg-secondary"></span>
                                                            {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>

                                        <h6>Equipo Rojo (Red Team)</h6>
                                        <table class="player-detail-table">
                                            <thead>
                                                <tr>
                                                    <th>Campeón</th>
                                                    <th>Jugador</th>
                                                    <th>KDA</th>
                                                    <th>Objetos</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for participant in match.all_participants %}
                                                {% if participant.team_id == 200 %}
                                                <tr>
                                                    <td>
                                                        <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ participant.champion_name }}.png" alt="{{ participant.champion_name }}" class="champion-icon-small">
                                                    </td>
                                                    <td>{{ participant.summoner_name }}</td>
                                                    <td>{{ participant.kills }}/{{ participant.deaths }}/{{ participant.assists }} {% if participant.win %}(Victoria){% else %}(Derrota){% endif %}</td>
                                                    <td>
                                                        <div class="items-grid-small">
                                                            {% for item_id in participant.items[:6] %}
                                                            {% if item_id != 0 %}
                                                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/item/{{ item_id }}.png" alt="Item">
                                                            {% else %}
                                                            <span class="item-placeholder-small bg-secondary"></span>
                                                            {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center" id="paginationControls">
                        </ul>
                </nav>
            </div>
        </div>
    </div>

    <footer class="footer mt-auto py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">Desarrollado con ❤️ por Sepevalle &copy; 2024</span>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const backgroundAudio = document.getElementById('backgroundAudio');
            const toggleAudioButton = document.getElementById('toggleAudio');
            const muteIcon = document.getElementById('muteIcon');
            const volumeSlider = document.getElementById('volumeSlider');
            const bannerImg = document.getElementById('banner-img');
            const leftBanner = document.getElementById('left-banner');
            const rightBanner = document.getElementById('right-banner');
            const toggleModeButton = document.getElementById('toggle-mode');
            const allMatchRows = Array.from(document.querySelectorAll('#matchHistoryTableBody .match-row'));
            const queueFilter = document.getElementById('queueFilter');
            const championFilter = document.getElementById('championFilter');
            const paginationControls = document.getElementById('paginationControls');
            let currentPage = 1;
            const rowsPerPage = 10;
            const itemBaseUrl = "https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/item/";

            // Banners laterales
            const bannerImages = [
                'https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/1.jpg',
                'https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/2.jpg',
                'https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/3.jpg',
                'https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/4.jpg',
                'https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/5.jpg',
                'https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/6.jpg'
            ];

            let currentBannerIndex = 0;
            function changeBanners() {
                currentBannerIndex = (currentBannerIndex + 1) % bannerImages.length;
                const newSrc = bannerImages[currentBannerIndex];
                leftBanner.src = newSrc;
                rightBanner.src = newSrc;
            }
            setInterval(changeBanners, 30000); // Cambia cada 30 segundos

            // Carrusel de banners superior
            const topBannerImages = [
                'https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/refs/heads/main/banners/Banner1.png',
                'https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/refs/heads/main/banners/Banner2.png',
                'https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/refs/heads/main/banners/Banner3.png',
                'https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/refs/heads/main/banners/Banner4.png',
                'https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/refs/heads/main/banners/Banner5.png',
                'https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/refs/heads/main/banners/Banner6.png'
            ];

            let currentTopBannerIndex = 0;
            function changeTopBanner() {
                currentTopBannerIndex = (currentTopBannerIndex + 1) % topBannerImages.length;
                bannerImg.src = topBannerImages[currentTopBannerIndex];
            }
            setInterval(changeTopBanner, 15000); // Cambia cada 15 segundos


            // Carga y estado del audio
            backgroundAudio.volume = localStorage.getItem('audioVolume') !== null ? parseFloat(localStorage.getItem('audioVolume')) : 1;
            volumeSlider.value = backgroundAudio.volume;
            if (localStorage.getItem('audioMuted') === 'true') {
                backgroundAudio.muted = true;
                muteIcon.classList.remove('fa-volume-up');
                muteIcon.classList.add('fa-microphone-slash');
                toggleAudioButton.title = "Desmutear Música";
            } else {
                backgroundAudio.muted = false;
                muteIcon.classList.remove('fa-microphone-slash');
                muteIcon.classList.add('fa-volume-up');
                toggleAudioButton.title = "Mutear Música";
                backgroundAudio.play().catch(e => console.error("Error al reproducir audio:", e));
            }

            toggleAudioButton.addEventListener('click', () => {
                backgroundAudio.muted = !backgroundAudio.muted;
                localStorage.setItem('audioMuted', backgroundAudio.muted);
                if (backgroundAudio.muted) {
                    muteIcon.classList.remove('fa-volume-up');
                    muteIcon.classList.add('fa-microphone-slash');
                    toggleAudioButton.title = "Desmutear Música";
                } else {
                    muteIcon.classList.remove('fa-microphone-slash');
                    muteIcon.classList.add('fa-volume-up');
                    toggleAudioButton.title = "Mutear Música";
                    backgroundAudio.play().catch(e => console.error("Error al reproducir audio al desmutear:", e));
                }
            });

            volumeSlider.addEventListener('input', () => {
                backgroundAudio.volume = volumeSlider.value;
                localStorage.setItem('audioVolume', volumeSlider.value);
            });

            // Modo oscuro
            function applyDarkMode(isDark) {
                document.body.classList.toggle('dark-mode', isDark);
                // Ajusta el texto del botón según el modo
                toggleModeButton.textContent = isDark ? 'Modo Claro' : 'Modo Oscuro';
            }

            // Cargar la preferencia de modo oscuro al inicio
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode !== null) {
                applyDarkMode(savedDarkMode === 'true');
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                // Si no hay preferencia guardada, pero el sistema prefiere el modo oscuro
                applyDarkMode(true);
            }

            toggleModeButton.addEventListener('click', () => {
                const isDark = document.body.classList.contains('dark-mode');
                applyDarkMode(!isDark);
                localStorage.setItem('darkMode', !isDark);
            });

            // --- LÓGICA DE FILTRADO Y PAGINACIÓN ---
            function populateChampionFilter() {
                const championNames = new Set();
                allMatchRows.forEach(row => {
                    const championName = row.dataset.championName;
                    if (championName && championName !== "Desconocido") {
                        championNames.add(championName);
                    }
                });
                const sortedChampionNames = Array.from(championNames).sort();
                sortedChampionNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    championFilter.appendChild(option);
                });
            }

            function populateQueueFilter() {
                const queueNames = new Set();
                // Aquí deberías tener un mapeo de queue_id a nombre legible, por ejemplo:
                const queueMap = {
                    400: "Normal (Blind Pick)",
                    420: "Clasificatoria Solo/Duo",
                    430: "Normal (Draft Pick)",
                    440: "Clasificatoria Flexible",
                    450: "ARAM",
                    700: "Clash",
                    800: "Co-op vs. AI (Beginner)",
                    810: "Co-op vs. AI (Intermediate)",
                    820: "Co-op vs. AI (Intro)",
                    830: "Co-op vs. AI (Twisted Treeline)",
                    840: "Co-op vs. AI (Summoner's Rift)",
                    850: "Co-op vs. AI (ARAM)",
                    900: "URF",
                    1020: "One For All",
                    1090: "Arena", // Ocasional, por ejemplo para eventos
                    1100: "Arena", // Ocasional, por...
                    1300: "Nexus Blitz",
                    1400: "Ultimate Spellbook",
                    1700: "Arena",
                    1900: "URF (ARAM)",
                    2000: "Tutorial",
                    2010: "Tutorial",
                    2020: "Tutorial",
                    // Asegúrate de que este mapeo coincida con tu backend
                };

                allMatchRows.forEach(row => {
                    const queueId = row.dataset.queueId;
                    if (queueId && queueMap[queueId]) {
                        queueNames.add(JSON.stringify({ id: queueId, name: queueMap[queueId] }));
                    }
                });

                const sortedQueueNames = Array.from(queueNames)
                    .map(item => JSON.parse(item))
                    .sort((a, b) => a.name.localeCompare(b.name));

                sortedQueueNames.forEach(queue => {
                    const option = document.createElement('option');
                    option.value = queue.id;
                    option.textContent = queue.name;
                    queueFilter.appendChild(option);
                });
            }

            function setupPagination(totalRows, currentPage) {
                const totalPages = Math.ceil(totalRows / rowsPerPage);
                paginationControls.innerHTML = ''; // Limpiar controles existentes

                if (totalPages > 1) {
                    // Botón "Anterior"
                    const prevLi = document.createElement('li');
                    prevLi.classList.add('page-item');
                    if (currentPage === 1) prevLi.classList.add('disabled');
                    prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Anterior</a>`;
                    paginationControls.appendChild(prevLi);

                    // Números de página
                    for (let i = 1; i <= totalPages; i++) {
                        const pageLi = document.createElement('li');
                        pageLi.classList.add('page-item');
                        if (i === currentPage) pageLi.classList.add('active');
                        pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                        paginationControls.appendChild(pageLi);
                    }

                    // Botón "Siguiente"
                    const nextLi = document.createElement('li');
                    nextLi.classList.add('page-item');
                    if (currentPage === totalPages) nextLi.classList.add('disabled');
                    nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Siguiente</a>`;
                    paginationControls.appendChild(nextLi);
                }
            }

            function renderMatchHistory() {
                const selectedQueue = queueFilter.value;
                const selectedChampion = championFilter.value;

                const filteredRows = allMatchRows.filter(row => {
                    const isQueueMatch = selectedQueue === 'all' || row.dataset.queueId === selectedQueue;
                    const isChampionMatch = selectedChampion === 'all' || row.dataset.championName === selectedChampion;
                    return isQueueMatch && isChampionMatch;
                });

                // Ocultar todas las filas de detalles antes de renderizar
                document.querySelectorAll('.match-details-row').forEach(row => {
                    row.classList.remove('show'); // Asegura que el colapso esté cerrado
                    row.style.display = 'none'; // También oculta la fila contenedora
                });

                setupPagination(filteredRows.length, currentPage);

                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = startIndex + rowsPerPage;

                allMatchRows.forEach(row => row.style.display = 'none'); // Ocultar todas las filas principales

                filteredRows.forEach((row, index) => {
                    if (index >= startIndex && index < endIndex) {
                        row.style.display = ''; // Mostrar la fila principal si está en la página actual
                        const detailRowId = row.querySelector('.toggle-details-btn').dataset.bsTarget;
                        document.querySelector(detailRowId).style.display = ''; // Mostrar la fila de detalles asociada
                    } else {
                        const detailRowId = row.querySelector('.toggle-details-btn').dataset.bsTarget;
                        document.querySelector(detailRowId).style.display = 'none'; // Ocultar la fila de detalles si la principal no está en la página
                    }
                });

                // Añadir evento de clic a los botones "Ver detalles"
                document.querySelectorAll('.toggle-details-btn').forEach(button => {
                    button.onclick = function() {
                        const targetId = this.dataset.bsTarget;
                        const targetElement = document.querySelector(targetId);
                        const isExpanded = this.getAttribute('aria-expanded') === 'true';

                        // Toggle the visibility for the next row
                        const nextSibling = this.closest('tr').nextElementSibling;
                        if (nextSibling && nextSibling.classList.contains('match-details-row')) {
                            if (isExpanded) {
                                nextSibling.style.display = 'none'; // Hide if already expanded
                            } else {
                                nextSibling.style.display = ''; // Show if collapsed
                            }
                        }
                    };
                });
            }


            // --- EVENT LISTENERS ---
            queueFilter.addEventListener('change', () => {
                currentPage = 1;
                renderMatchHistory();
            });
            championFilter.addEventListener('change', () => {
                currentPage = 1;
                renderMatchHistory();
            });

            paginationControls.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('.page-link');
                if (!target || target.parentElement.classList.contains('disabled')) return;

                const newPage = parseInt(target.dataset.page, 10);
                if (newPage !== currentPage) {
                    currentPage = newPage;
                    renderMatchHistory();
                }
            });

            // --- INICIALIZACIÓN ---
            populateChampionFilter();
            populateQueueFilter();
            renderMatchHistory();
            // --- FIN: LÓGICA DE FILTRADO Y PAGINACIÓN ---
        });
    </script>

</body>

</html>