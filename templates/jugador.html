<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Jugador - {{ perfil.nombre }}</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/Icono.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/style.css">
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        .banner-img {
            margin-top: 40px;
            width: 100%;
            max-height: 600px;
            object-fit: contain;
        }
        .small-text {
            font-size: 0.6em;
            font-weight: normal;
        }
        /* Estilos para las partidas */
        .match-card {
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: var(--card-bg-color); /* Usar variable CSS si la tienes */
            color: var(--text-color); /* Usar variable CSS si la tienes */
            border: 1px solid var(--border-color); /* Usar variable CSS si la tienes */
            /* Controlado por JS, oculto inicialmente si no está en la página actual */
            display: none; 
        }

        .match-card.active-page-match {
            display: block; /* Solo se muestra si está en la página activa */
        }

        .match-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            background-color: var(--header-bg-color); /* O un color distinto para el encabezado */
            border-bottom: 1px solid var(--border-color);
        }

        .match-header:hover {
            background-color: var(--header-hover-bg-color); /* Un ligero cambio al pasar el ratón */
        }

        .match-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            border: 2px solid; /* El color del borde puede indicar victoria/derrota */
        }

        .match-win .match-icon { border-color: #5cb85c; /* Verde para victoria */ }
        .match-loss .match-icon { border-color: #d9534f; /* Rojo para derrota */ }

        .match-info {
            flex-grow: 1;
        }

        .match-info h5 {
            margin-bottom: 0;
            font-size: 1.1em;
        }

        .match-info p {
            margin-bottom: 0;
            font-size: 0.85em;
            color: var(--secondary-text-color);
        }

        .match-kda {
            font-weight: bold;
            margin-left: 20px;
            white-space: nowrap; /* Evita que el KDA se divida en varias líneas */
        }

        .match-detail {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: none; /* Oculto por defecto */
        }

        .match-detail.expanded {
            display: block; /* Muestra cuando se expande */
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.9em;
        }

        .detail-item strong {
            display: block;
            margin-bottom: 3px;
            color: var(--primary-color); /* Color para los títulos de las estadísticas */
        }

        /* Dark Mode styles (assuming you have a toggle or system preference) */
        body.dark-mode {
            background-color: #2c2c2c;
            color: #f0f0f0;
        }
        body.dark-mode .match-card {
            background-color: #3a3a3a;
            border-color: #555;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .match-header {
            background-color: #4a4a4a;
            border-bottom-color: #555;
        }
        body.dark-mode .match-header:hover {
            background-color: #5a5a5a;
        }
        body.dark-mode .match-info p {
            color: #ccc;
        }
        body.dark-mode .match-detail {
            border-top-color: #555;
        }
        body.dark-mode .detail-item strong {
            color: #88c0d0; /* Un color de acento para dark mode */
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .pagination-controls button {
            margin: 0 5px;
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-bg-color);
            color: var(--text-color);
            cursor: pointer;
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-controls span {
            font-weight: bold;
            color: var(--text-color);
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <div class="text-center">
            <img src="{{ perfil.banner_champion_splash }}" alt="{{ perfil.nombre }} Banner" class="banner-img img-fluid rounded">
        </div>

        <h1 class="text-center my-4">
            <img src="{{ perfil.perfil_icon_url }}" alt="Icono de Perfil" class="rounded-circle me-2" width="80" height="80">
            {{ perfil.nombre }}
            {% if perfil.tagline %}
                <span class="small-text">#{{ perfil.tagline }}</span>
            {% endif %}
        </h1>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card p-3">
                    <h4>Clasificatoria Solo/Duo</h4>
                    <p>Liga: {{ perfil.ranked_solo_tier }} {{ perfil.ranked_solo_rank }} ({{ perfil.ranked_solo_lp }} LP)</p>
                    <p>Victorias: {{ perfil.ranked_solo_wins }} / Derrotas: {{ perfil.ranked_solo_losses }}</p>
                    <p>Win Rate: {{ (perfil.ranked_solo_wins / (perfil.ranked_solo_wins + perfil.ranked_solo_losses) * 100) | round(2) if (perfil.ranked_solo_wins + perfil.ranked_solo_losses) > 0 else 0 }}%</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3">
                    <h4>Clasificatoria Flexible</h4>
                    <p>Liga: {{ perfil.ranked_flex_tier }} {{ perfil.ranked_flex_rank }} ({{ perfil.ranked_flex_lp }} LP)</p>
                    <p>Victorias: {{ perfil.ranked_flex_wins }} / Derrotas: {{ perfil.ranked_flex_losses }}</p>
                    <p>Win Rate: {{ (perfil.ranked_flex_wins / (perfil.ranked_flex_wins + perfil.ranked_flex_losses) * 100) | round(2) if (perfil.ranked_flex_wins + perfil.ranked_flex_losses) > 0 else 0 }}%</p>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label for="queueFilter" class="form-label">Filtrar por Cola:</label>
                <select id="queueFilter" class="form-select">
                    <option value="all">Todas</option>
                    <option value="420">Clasificatoria Solo/Duo</option>
                    <option value="440">Clasificatoria Flexible</option>
                    <option value="400">Normal (Blind Pick)</option>
                    <option value="430">Normal (Draft Pick)</option>
                    <option value="450">ARAM</option>
                    </select>
            </div>
            <div class="col-md-6">
                <label for="championFilter" class="form-label">Filtrar por Campeón:</label>
                <select id="championFilter" class="form-select">
                    <option value="all">Todos</option>
                    </select>
            </div>
        </div>

        <h2 class="mt-5 mb-3">Historial de Partidas</h2>
        <div id="match-history-container">
            {% for match in perfil.historial_partidas %}
            <div class="match-card match-{{ 'win' if match.win else 'loss' }}"
                 data-queue-id="{{ match.queue_id }}"
                 data-champion-name="{{ match.champion_name }}">
                
                <div class="match-header" onclick="toggleMatchDetail(this)">
                    <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ match.champion_name }}.png" 
                         alt="{{ match.champion_name }}" class="match-icon">
                    <div class="match-info">
                        <h5>{{ match.champion_name }} - {{ 'Victoria' if match.win else 'Derrota' }} ({{ match.queue_id | get_queue_type }})</h5>
                        <p>
                            KDA: {{ match.kills }}/{{ match.deaths }}/{{ match.assists }}
                            <br>
                            Hace: {{ (now - datetime.fromtimestamp(match.game_end_timestamp / 1000)).days }} días
                        </p>
                    </div>
                    <div class="match-kda">
                        {{ ((match.kills + match.assists) / match.deaths) | round(2) if match.deaths > 0 else ((match.kills + match.assists) | round(2)) if match.kills + match.assists > 0 else '0.00' }} KDA
                        <br>
                        <i class="fas fa-chevron-down"></i> </div>
                </div>

                <div class="match-detail">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Duración:</strong> {{ (match.game_duration / 60) | round(0) }}m {{ (match.game_duration % 60) | round(0) }}s
                        </div>
                        <div class="detail-item">
                            <strong>Nivel de Campeón:</strong> {{ match.champion_level }}
                        </div>
                        <div class="detail-item">
                            <strong>Farm (CS):</strong> {{ match.total_minions_killed }} ({{ (match.total_minions_killed / (match.game_duration / 60)) | round(1) if match.game_duration > 0 else 0 }} CS/min)
                        </div>
                        <div class="detail-item">
                            <strong>Oro Ganado:</strong> {{ "{:,.0f}".format(match.gold_earned) }}
                        </div>
                        <div class="detail-item">
                            <strong>Daño a Campeones:</strong> {{ "{:,.0f}".format(match.total_damage_dealt_to_champions) }}
                        </div>
                        <div class="detail-item">
                            <strong>Daño a Objetivos:</strong> {{ "{:,.0f}".format(match.damage_dealt_to_objectives) }}
                        </div>
                        <div class="detail-item">
                            <strong>Puntuación de Visión:</strong> {{ match.vision_score }}
                        </div>
                        <div class="detail-item">
                            <strong>Wards Colocados:</strong> {{ match.wards_placed }}
                        </div>
                        <div class="detail-item">
                            <strong>Wards Destruidos:</strong> {{ match.wards_killed }}
                        </div>
                        <div class="detail-item">
                            <strong>Curación Total:</strong> {{ "{:,.0f}".format(match.total_heal) }}
                        </div>
                        <div class="detail-item">
                            <strong>CC a Enemigos:</strong> {{ match.time_ccing_others | round(1) }}s
                        </div>
                        <div class="detail-item">
                            <strong>Torretas Destruidas:</strong> {{ match.turret_kills }}
                        </div>
                        <div class="detail-item">
                            <strong>Pentakills:</strong> {{ match.penta_kills }}
                        </div>
                        <div class="detail-item">
                            <strong>Quadrakills:</strong> {{ match.quadra_kills }}
                        </div>
                        <div class="detail-item">
                            <strong>Triplekills:</strong> {{ match.triple_kills }}
                        </div>
                        <div class="detail-item">
                            <strong>Doblekills:</strong> {{ match.double_kills }}
                        </div>
                    </div>
                    <hr>
                    <h6>Objetos:</h6>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        {% for item_id in match.items %}
                            {% if item_id != 0 %}
                                <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/item/{{ item_id }}.png" alt="Item" width="30" height="30" class="rounded">
                            {% endif %}
                        {% endfor %}
                    </div>
                    <h6>Hechizos:</h6>
                    <div class="d-flex gap-2 mb-3">
                        {% if match.summoner_spell_1_id %}
                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/{{ match.summoner_spell_1_id }}.png" alt="Spell 1" width="30" height="30" class="rounded">
                        {% endif %}
                        {% if match.summoner_spell_2_id %}
                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/{{ match.summoner_spell_2_id }}.png" alt="Spell 2" width="30" height="30" class="rounded">
                        {% endif %}
                    </div>
                    <h6>Runas:</h6>
                    <div class="d-flex gap-2">
                        {% if match.perk_main_id %}
                            <img src="https://ddragon.leagueoflegends.com/cdn/img/{{ match.perk_main_id }}" alt="Runa Principal" width="30" height="30" class="rounded">
                        {% endif %}
                        {% if match.perk_sub_id %}
                            <img src="https://ddragon.leagueoflegends.com/cdn/img/perkStyle/{{ match.perk_sub_id }}.png" alt="Runa Secundaria" width="30" height="30" class="rounded">
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="pagination-controls">
            <button id="prevPageBtn" disabled>Anterior</button>
            <span id="pageInfo">Página 1 de 1</span>
            <button id="nextPageBtn" disabled>Siguiente</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const queueFilter = document.getElementById('queueFilter');
            const championFilter = document.getElementById('championFilter');
            const matchHistoryContainer = document.getElementById('match-history-container');
            const allMatchCards = Array.from(document.querySelectorAll('.match-card')); // Convert NodeList to Array
            
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const pageInfoSpan = document.getElementById('pageInfo');

            const matchesPerPage = 10;
            let currentPage = 1;
            let filteredMatches = []; // This will hold the matches currently passing the filters

            // Access perfil data from the Jinja2 context by embedding it as a JSON object
            const perfilData = {{ perfil | tojson }};
            const allMatchHistoryData = perfilData.historial_partidas || []; // Raw match data from Flask

            function populateChampionFilter() {
                const uniqueChampions = new Set();
                allMatchHistoryData.forEach(match => { // Use raw data for filter population
                    if (match.champion_name) {
                        uniqueChampions.add(match.champion_name);
                    }
                });

                const sortedChampions = Array.from(uniqueChampions).sort();
                championFilter.innerHTML = '<option value="all">Todos</option>'; // Reset
                sortedChampions.forEach(champion => {
                    const option = document.createElement('option');
                    option.value = champion;
                    option.textContent = champion;
                    championFilter.appendChild(option);
                });
            }

            function applyMatchHistoryFilters() {
                const selectedQueue = queueFilter.value;
                const selectedChampion = championFilter.value;

                // First, filter the matches
                filteredMatches = allMatchCards.filter(matchCard => {
                    const matchQueueId = matchCard.dataset.queueId;
                    const matchChampionName = matchCard.dataset.championName;

                    const isQueueMatch = (selectedQueue === 'all' || matchQueueId == selectedQueue);
                    const isChampionMatch = (selectedChampion === 'all' || matchChampionName === selectedChampion);
                    
                    return isQueueMatch && isChampionMatch;
                });
                
                currentPage = 1; // Reset to first page after filtering
                displayMatches();
                updatePaginationControls();
            }

            function displayMatches() {
                const startIndex = (currentPage - 1) * matchesPerPage;
                const endIndex = startIndex + matchesPerPage;

                // Hide all match cards first
                allMatchCards.forEach(card => card.classList.remove('active-page-match'));

                // Show only the matches for the current page
                for (let i = startIndex; i < endIndex && i < filteredMatches.length; i++) {
                    filteredMatches[i].classList.add('active-page-match');
                }
            }

            function updatePaginationControls() {
                const totalPages = Math.ceil(filteredMatches.length / matchesPerPage);
                pageInfoSpan.textContent = `Página ${currentPage} de ${totalPages || 1}`; // Handle 0 matches case

                prevPageBtn.disabled = (currentPage === 1);
                nextPageBtn.disabled = (currentPage === totalPages || totalPages === 0);
            }

            // Function to toggle match detail
            window.toggleMatchDetail = function(headerElement) {
                const matchCard = headerElement.closest('.match-card');
                const detailElement = matchCard.querySelector('.match-detail');
                const chevronIcon = headerElement.querySelector('.fa-chevron-down, .fa-chevron-up');

                if (detailElement.classList.contains('expanded')) {
                    detailElement.classList.remove('expanded');
                    if (chevronIcon) {
                        chevronIcon.classList.remove('fa-chevron-up');
                        chevronIcon.classList.add('fa-chevron-down');
                    }
                } else {
                    detailElement.classList.add('expanded');
                    if (chevronIcon) {
                        chevronIcon.classList.remove('fa-chevron-down');
                        chevronIcon.classList.add('fa-chevron-up');
                    }
                }
            };

            // Event Listeners for Pagination Buttons
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayMatches();
                    updatePaginationControls();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredMatches.length / matchesPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    displayMatches();
                    updatePaginationControls();
                }
            });

            // Attach event listeners to filters
            queueFilter.addEventListener('change', applyMatchHistoryFilters);
            championFilter.addEventListener('change', applyMatchHistoryFilters);

            // Initial setup
            populateChampionFilter();
            applyMatchHistoryFilters(); // This will also call displayMatches and updatePaginationControls for the first time

            // Toggle Dark/Light Mode (Example - you might have this elsewhere)
            const darkModeToggle = document.getElementById('darkModeToggle'); // Asegúrate de tener un botón/checkbox con este ID
            if (darkModeToggle) {
                darkModeToggle.addEventListener('change', function() {
                    document.body.classList.toggle('dark-mode', this.checked);
                    localStorage.setItem('darkMode', this.checked); // Guardar preferencia
                });
                // Cargar preferencia al inicio
                if (localStorage.getItem('darkMode') === 'true') {
                    document.body.classList.add('dark-mode');
                    darkModeToggle.checked = true;
                }
            }
        });
    </script>

    </body>
</html>