{% extends "base.html" %}

{% block title %}Detalle de Partida - Cerditos y Valientes{% endblock %}

{% block nav_items %}{% endblock %}

{% block extra_styles %}
<style>
    .match-page {
        padding-bottom: 3rem;
    }

    .match-summary-card {
        border: 0;
        border-radius: 0.9rem;
        overflow: hidden;
    }

    .match-summary-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }

    .team-panel {
        border-radius: 0.75rem;
        padding: 1rem;
        height: 100%;
    }

    .team-panel.blue {
        background-color: rgba(0, 123, 255, 0.08);
    }

    .team-panel.red {
        background-color: rgba(220, 53, 69, 0.08);
    }

    .participant-table {
        margin-bottom: 0;
    }

    .participant-table th,
    .participant-table td {
        white-space: nowrap;
    }

    .spell-rune-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 3px;
    }

    .spell-rune-container img {
        width: 20px;
        height: 20px;
        border-radius: 3px;
    }

    .spell-rune-container .runes {
        display: flex;
        flex-direction: column;
    }

    .spell-rune-container .runes img {
        width: 16px;
        height: 16px;
        border-radius: 50%;
    }

    .spell-rune-container .runes img.keystone {
        border: 1px solid gold;
    }

    .spell-rune-container .runes img.sub-rune {
        border: 1px solid #6c757d;
    }

    .gemini-card {
        border: 0;
        border-radius: 0.9rem;
    }

    .gemini-content p {
        white-space: pre-wrap;
        margin-bottom: 0;
    }

    .gemini-block {
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 0.7rem;
        padding: 0.9rem;
        background: rgba(248, 249, 250, 0.65);
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 pt-5 match-page">
    {% if match and perfil %}
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-4">
        <h1 class="mb-0">Detalle de Partida</h1>
        <span class="badge bg-secondary">ID: {{ match.match_id }}</span>
    </div>

    <div class="card shadow-sm match-summary-card mb-4">
        <div class="card-header bg-primary text-white py-3">
            <h4 class="mb-0">
                {% if match.win %}
                <span class="text-success">Victoria</span>
                {% else %}
                <span class="text-danger">Derrota</span>
                {% endif %}
                - {{ match.champion_name }}
            </h4>
            <div class="match-summary-meta">
                <span class="badge bg-light text-dark">Duracion: {{ (match.game_duration / 60) | int }}m {{ (match.game_duration % 60) | int }}s</span>
                <span class="badge bg-light text-dark">KDA: {{ match.kills }}/{{ match.deaths }}/{{ match.assists }}</span>
                <span class="badge bg-light text-dark">Ratio: {{ '%.2f'|format((match.kills + match.assists) / match.deaths) if match.deaths > 0 else 'Perfecto' }}</span>
                <span class="badge bg-light text-dark">{{ match.queue_id | get_queue_type }}</span>
                <span class="badge bg-light text-dark">{{ match.game_end_timestamp | format_timestamp if match.game_end_timestamp else 'Fecha desconocida' }}</span>
            </div>
        </div>

        <div class="card-body p-3 p-lg-4">
            <div class="row g-4">
                <div class="col-12 col-xl-6">
                    <div class="team-panel blue shadow-sm">
                        <h5 class="text-primary fw-bold mb-3">
                            {% set team100_participants = match.all_participants | selectattr('team_id', 'equalto', 100) | list %}
                            {% set team100_won = team100_participants[0].win if team100_participants else false %}
                            {% if team100_participants %}{% if team100_won %}Victoria{% else %}Derrota{% endif %}{% endif %} - Equipo Azul
                        </h5>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle participant-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Campeon</th>
                                        <th>Jugador</th>
                                        <th>KDA</th>
                                        <th>Hechizos</th>
                                        <th>Runas</th>
                                        <th>Objetos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for participante in match.all_participants %}
                                        {% if participante.team_id == 100 %}
                                        <tr {% if participante.summoner_name == perfil.game_name.split('#')[0] %}class="table-warning"{% endif %}>
                                            <td>
                                                <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ participante.champion_name }}.png"
                                                     alt="{{ participante.champion_name }}"
                                                     style="width: 30px; height: 30px; border-radius: 50%; margin-right: 5px;">
                                                {{ participante.champion_name }}
                                            </td>
                                            <td class="fw-bold">{{ participante.summoner_name }}</td>
                                            <td>{{ participante.kills }}/{{ participante.deaths }}/{{ participante.assists }}</td>
                                            <td>
                                                <div class="spell-rune-container">
                                                    {% if participante.get('summoner_spell_1_id') %}
                                                        <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/{{ participante.get('summoner_spell_1_id') }}.png" alt="Spell 1">
                                                    {% endif %}
                                                    {% if participante.get('summoner_spell_2_id') %}
                                                        <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/{{ participante.get('summoner_spell_2_id') }}.png" alt="Spell 2">
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="spell-rune-container">
                                                    <div class="runes">
                                                        {% if participante.get('perk_main_id') %}
                                                            <img src="https://ddragon.leagueoflegends.com/cdn/img/{{ participante.perk_main_id }}" alt="Main Rune" class="keystone">
                                                        {% endif %}
                                                        {% if participante.get('perk_sub_id') %}
                                                            <img src="https://ddragon.leagueoflegends.com/cdn/img/{{ participante.perk_sub_id }}" alt="Sub Rune" class="sub-rune">
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center justify-content-center gap-1">
                                                    {% set items = participante.get('items', []) %}
                                                    {% for item_id in items %}
                                                        {% if item_id > 0 %}
                                                            <img style="width: 22px; height: 22px; border-radius: 3px;" src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/item/{{ item_id }}.png" alt="Item">
                                                        {% else %}
                                                            <div style="width: 22px; height: 22px; background-color: rgba(0, 0, 0, 0.2); border-radius: 3px;"></div>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-xl-6">
                    <div class="team-panel red shadow-sm">
                        <h5 class="text-danger fw-bold mb-3">
                            {% set team200_participants = match.all_participants | selectattr('team_id', 'equalto', 200) | list %}
                            {% set team200_won = team200_participants[0].win if team200_participants else false %}
                            {% if team200_participants %}{% if team200_won %}Victoria{% else %}Derrota{% endif %}{% endif %} - Equipo Rojo
                        </h5>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle participant-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Campeon</th>
                                        <th>Jugador</th>
                                        <th>KDA</th>
                                        <th>Hechizos</th>
                                        <th>Runas</th>
                                        <th>Objetos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for participante in match.all_participants %}
                                        {% if participante.team_id == 200 %}
                                        <tr {% if participante.summoner_name == perfil.game_name.split('#')[0] %}class="table-warning"{% endif %}>
                                            <td>
                                                <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ participante.champion_name }}.png"
                                                     alt="{{ participante.champion_name }}"
                                                     style="width: 30px; height: 30px; border-radius: 50%; margin-right: 5px;">
                                                {{ participante.champion_name }}
                                            </td>
                                            <td class="fw-bold">{{ participante.summoner_name }}</td>
                                            <td>{{ participante.kills }}/{{ participante.deaths }}/{{ participante.assists }}</td>
                                            <td>
                                                <div class="spell-rune-container">
                                                    {% if participante.get('summoner_spell_1_id') %}
                                                        <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/{{ participante.get('summoner_spell_1_id') }}.png" alt="Spell 1">
                                                    {% endif %}
                                                    {% if participante.get('summoner_spell_2_id') %}
                                                        <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/{{ participante.get('summoner_spell_2_id') }}.png" alt="Spell 2">
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="spell-rune-container">
                                                    <div class="runes">
                                                        {% if participante.get('perk_main_id') %}
                                                            <img src="https://ddragon.leagueoflegends.com/cdn/img/{{ participante.perk_main_id }}" alt="Main Rune" class="keystone">
                                                        {% endif %}
                                                        {% if participante.get('perk_sub_id') %}
                                                            <img src="https://ddragon.leagueoflegends.com/cdn/img/{{ participante.perk_sub_id }}" alt="Sub Rune" class="sub-rune">
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center justify-content-center gap-1">
                                                    {% set items = participante.get('items', []) %}
                                                    {% for item_id in items %}
                                                        {% if item_id > 0 %}
                                                            <img style="width: 22px; height: 22px; border-radius: 3px;" src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/item/{{ item_id }}.png" alt="Item">
                                                        {% else %}
                                                            <div style="width: 22px; height: 22px; background-color: rgba(0, 0, 0, 0.2); border-radius: 3px;"></div>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm gemini-card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="mb-0 text-primary">
                <i class="fas fa-brain me-2"></i>Analisis detallado con Gemini
            </h5>
            <button id="btn-gemini-match" class="btn btn-sm btn-outline-primary" onclick="ejecutarAnalisisPartidaIA()">
                <i class="fas fa-magic me-2"></i>Analizar esta partida
            </button>
        </div>

        <div class="card-body">
            <div id="gemini-loader" class="text-center py-4" style="display:none;">
                <div class="spinner-border text-primary mb-2" role="status"></div>
                <p class="text-muted mb-0">Gemini esta analizando la partida...</p>
            </div>

            <div id="gemini-error" class="alert alert-warning" style="display:none;"></div>

            <div id="gemini-content" class="gemini-content" style="display:none;">
                <div class="row g-3">
                    <div class="col-12 col-lg-6">
                        <div class="gemini-block">
                            <label class="fw-bold text-primary mb-2 d-block">Resumen de la partida</label>
                            <p id="gm-resumen"></p>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="gemini-block">
                            <label class="fw-bold text-success mb-2 d-flex justify-content-between align-items-center">
                                <span>Lectura de linea</span>
                                <span id="gm-linea-score" class="badge bg-success-subtle text-success-emphasis border">-/10</span>
                            </label>
                            <p id="gm-linea"></p>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="gemini-block">
                            <label class="fw-bold text-info mb-2 d-flex justify-content-between align-items-center">
                                <span>Impacto en mid game</span>
                                <span id="gm-mid-score" class="badge bg-info-subtle text-info-emphasis border">-/10</span>
                            </label>
                            <p id="gm-mid"></p>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="gemini-block">
                            <label class="fw-bold text-secondary mb-2 d-flex justify-content-between align-items-center">
                                <span>Impacto en late game</span>
                                <span id="gm-late-score" class="badge bg-secondary-subtle text-secondary-emphasis border">-/10</span>
                            </label>
                            <p id="gm-late"></p>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="gemini-block">
                            <label class="fw-bold text-danger mb-2 d-block">Errores clave</label>
                            <p id="gm-errores"></p>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="gemini-block">
                            <label class="fw-bold text-success mb-2 d-block">Aciertos clave</label>
                            <p id="gm-aciertos"></p>
                        </div>
                    </div>
                    <div class="col-12 col-lg-8">
                        <div class="gemini-block">
                            <label class="fw-bold text-warning mb-2 d-block">Plan de mejora</label>
                            <p id="gm-plan"></p>
                        </div>
                    </div>
                    <div class="col-12 col-lg-4">
                        <div class="gemini-block">
                            <label class="fw-bold text-dark mb-2 d-flex justify-content-between align-items-center">
                                <span>Veredicto final</span>
                                <span id="gm-veredicto-score" class="badge bg-dark-subtle text-dark-emphasis border">-/10</span>
                            </label>
                            <p id="gm-veredicto"></p>
                        </div>
                    </div>
                </div>

                <div class="mt-3 small text-muted" id="gm-meta"></div>
            </div>
        </div>
    </div>

    <div class="text-center">
        <a href="{{ url_for('player.perfil_jugador', game_name=perfil.game_name) }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>Volver al perfil de {{ perfil.nombre }}
        </a>
    </div>
    {% else %}
    <div class="alert alert-info">
        No se encontraron detalles de la partida.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function ejecutarAnalisisPartidaIA() {
    const btn = document.getElementById('btn-gemini-match');
    const loader = document.getElementById('gemini-loader');
    const errorDiv = document.getElementById('gemini-error');
    const content = document.getElementById('gemini-content');

    const matchId = "{{ match.match_id if match else '' }}";
    const puuid = "{{ perfil.puuid if perfil else '' }}";
    const playerName = "{{ perfil.game_name if perfil else '' }}";

    if (!matchId) {
        errorDiv.style.display = 'block';
        errorDiv.innerText = 'No se pudo identificar el match_id para el analisis.';
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analizando...';
    loader.style.display = 'block';
    errorDiv.style.display = 'none';
    content.style.display = 'none';

    try {
        const url = `/api/analisis-ia/partida/${encodeURIComponent(matchId)}?puuid=${encodeURIComponent(puuid)}&player_name=${encodeURIComponent(playerName)}`;
        const response = await fetch(url);
        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error || result.mensaje || 'No se pudo generar el analisis.');
        }

        const data = result.data || {};

        const setText = (id, value, fallback) => {
            const el = document.getElementById(id);
            if (el) {
                el.innerText = value || fallback;
            }
        };

        const setScore = (id, value) => {
            const el = document.getElementById(id);
            if (!el) return;
            if (value === null || value === undefined || value === '') {
                el.innerText = '-/10';
                return;
            }
            const num = Number(value);
            el.innerText = Number.isFinite(num) ? `${num.toFixed(1)}/10` : '-/10';
        };

        setText('gm-resumen', data.resumen_partida, 'Sin resumen disponible.');
        setText('gm-linea', data.lectura_de_linea, 'Sin lectura de linea.');
        setText('gm-mid', data.impacto_mid_game, 'Sin analisis de mid game.');
        setText('gm-late', data.impacto_late_game, 'Sin analisis de late game.');
        setText('gm-errores', data.errores_clave, 'Sin errores clave detectados.');
        setText('gm-aciertos', data.aciertos_clave, 'Sin aciertos clave detectados.');
        setText('gm-plan', data.plan_de_mejora, 'Sin plan de mejora disponible.');
        setText('gm-veredicto', data.veredicto_final, 'Sin veredicto final.');
        setScore('gm-linea-score', data.lectura_de_linea_score);
        setScore('gm-mid-score', data.impacto_mid_game_score);
        setScore('gm-late-score', data.impacto_late_game_score);
        setScore('gm-veredicto-score', data.veredicto_final_score);

        const meta = result._metadata || {};
        document.getElementById('gm-meta').innerText = meta.generated_at
            ? `Analisis generado: ${meta.generated_at}`
            : 'Analisis generado por Gemini.';

        loader.style.display = 'none';
        content.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-rotate-right me-2"></i>Reanalizar partida';
        btn.className = 'btn btn-sm btn-primary';
        btn.disabled = false;
    } catch (err) {
        loader.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.innerText = `Error: ${err.message}`;
        btn.innerHTML = '<i class="fas fa-triangle-exclamation me-2"></i>Reintentar';
        btn.className = 'btn btn-sm btn-outline-danger';
        btn.disabled = false;
    }
}
</script>
{% endblock %}
