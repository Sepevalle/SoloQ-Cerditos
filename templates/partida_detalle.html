{% extends "base.html" %}

{% block title %}Detalle de Partida - Cerditos y Valientes{% endblock %}

{% block nav_items %}
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('main.index') }}">Inicio</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('stats.estadisticas_globales') }}">Estadísticas Globales</a>
</li>
{% endblock %}

{% block extra_styles %}
<style>
    body {
        transition: background-color 0.3s, color 0.3s;
    }
    .banner-img {
        margin-top: 40px;
        width: 100%;
        max-height: 600px;
        object-fit: contain;
    }
    .small-text {
        font-size: 0.6em;
        font-weight: normal;
        color: #6c757d;
    }
    .small-text-stats {
        font-size: 0.8em;
        color: #6c757d;
    }
    .dark-mode .small-text-stats, .dark-mode .small-text {
        color: #adb5bd;
    }
    .dark-mode {
        background-color: #121212;
        color: #ffffff;
    }
    .dark-mode .navbar {
        background-color: #343a40 !important;
        color: white;
    }
    .dark-mode .navbar-brand {
        color: white !important;
    }
    .dark-mode .table, .dark-mode .card {
        background-color: #343a40 !important;
        color: white;
    }
    .dark-mode .nav-link {
        color: white !important;
    }
    .dark-mode .navbar-toggler-icon {
        filter: invert(1) grayscale(100%) brightness(2);
    }
    .table td, .table th {
        text-align: center;
        vertical-align: middle;
    }
    .lateral-img {
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        width: 150px;
        height: auto;
        object-fit: cover;
        display: none;
    }
    @media (min-width: 1500px) {
        .lateral-img {
            display: block;
        }
    }
    .left-img {
        left: 20px;
    }
    .right-img {
        right: 20px;
    }
    .dark-mode .match-row-win > td {
        background-color: rgba(40, 167, 69, 0.15);
    }
    .dark-mode .match-row-loss > td {
        background-color: rgba(220, 53, 69, 0.15);
    }
    .match-row-win > td {
        background-color: rgba(40, 167, 69, 0.08);
    }
    .match-row-loss > td {
        background-color: rgba(220, 53, 69, 0.08);
    }
    .dark-mode .table thead th {
        background-color: #495057 !important;
        color: #fff !important;
    }
    .dark-mode .table tbody td {
        border-color: #6c757d !important;
    }
    .dark-mode .card {
        background-color: #343a40 !important;
        border-color: #6c757d !important;
    }
    .dark-mode .card-header {
        background-color: #495057 !important;
        color: #fff !important;
    }
    .dark-mode a {
        color: #66b3ff;
    }
    .dark-mode a:hover {
        color: #99ccff;
    }
    .dark-mode .text-muted {
        color: #adb5bd !important;
    }
    
    /* Estilos específicos para los detalles de partida */
    .participant-card {
        margin-bottom: 15px;
        border-radius: 8px;
        overflow: hidden;
    }
    .participant-card .card-header {
        padding: 10px 15px;
    }
    .participant-card .card-body {
        padding: 10px;
    }
    .participant-row {
        display: flex;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .dark-mode .participant-row {
        border-bottom-color: rgba(255,255,255,0.1);
    }
    .participant-row:last-child {
        border-bottom: none;
    }
    .participant-champion {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .participant-name {
        flex: 1;
        font-weight: bold;
    }
    .participant-stats {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    .participant-kda {
        font-family: monospace;
        font-weight: bold;
    }
    .participant-items {
        display: flex;
        gap: 3px;
    }
    .participant-items img {
        width: 22px;
        height: 22px;
        border-radius: 3px;
    }
    .participant-spells {
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-right: 10px;
    }
    .participant-spells img {
        width: 18px;
        height: 18px;
        border-radius: 3px;
    }
    .participant-runes {
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-right: 10px;
    }
    .participant-runes img {
        width: 16px;
        height: 16px;
        border-radius: 50%;
    }
    .participant-runes img.keystone {
        border: 1px solid gold;
    }
    .participant-runes img.sub-rune {
        border: 1px solid #6c757d;
    }
    .match-header {
        text-align: center;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    .match-header.victory {
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.2), rgba(40, 167, 69, 0.1));
    }
    .match-header.defeat {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.2), rgba(220, 53, 69, 0.1));
    }
    .dark-mode .match-header.victory {
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.3), rgba(40, 167, 69, 0.2));
    }
    .dark-mode .match-header.defeat {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.3), rgba(220, 53, 69, 0.2));
    }
    .champion-icon-lg {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 3px solid #007bff;
    }
    .kda-lg {
        font-size: 1.5em;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<img id="left-banner" class="lateral-img left-img" src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/1.jpg" alt="Lateral izquierda">
<img id="right-banner" class="lateral-img right-img" src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/1.jpg" alt="Lateral derecha">

<div class="container my-4 d-flex justify-content-center">
    <img src="https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/refs/heads/main/banners/Banner5.png" alt="Banner" class="banner-img" id="banner-img">
</div>

<div class="container mt-5">
    {% if match and perfil %}
    <!-- Encabezado del partido -->
    <div class="match-header {{ 'victory' if match.win else 'defeat' }}">
        <div class="row align-items-center">
            <div class="col-md-4 text-center">
                <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ match.champion_name }}.png" 
                     alt="{{ match.champion_name }}" 
                     class="champion-icon-lg">
                <h4 class="mt-3">{{ match.champion_name }}</h4>
                <span class="badge bg-secondary">Nivel {{ match.champion_level }}</span>
            </div>
            <div class="col-md-4 text-center">
                <h2 class="{{ 'text-success' if match.win else 'text-danger' }} fw-bold">
                    {{ 'VICTORIA' if match.win else 'DERROTA' }}
                </h2>
                <p class="kda-lg">
                    {{ match.kills }}/{{ match.deaths }}/{{ match.assists }}
                    <small class="text-muted">
                        ({{ '%.2f'|format((match.kills + match.assists) / match.deaths) if match.deaths > 0 else 'Perfecto' }} KDA)
                    </small>
                </p>
                <p class="mb-0">
                    <span class="badge bg-primary">{{ match.queue_id | get_queue_type }}</span>
                    <span class="badge bg-secondary ms-2">
                        <i class="far fa-clock"></i> {{ (match.game_duration / 60) | int }}m {{ (match.game_duration % 60) | int }}s
                    </span>
                </p>
            </div>
            <div class="col-md-4 text-center">
                <p class="text-muted mb-2">
                    {{ match.game_end_timestamp | format_timestamp if match.game_end_timestamp else 'Fecha desconocida' }}
                </p>
                <a href="{{ url_for('player.perfil_jugador', game_name=perfil.game_name) }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>Volver al perfil
                </a>
            </div>
        </div>
    </div>

    <!-- Equipos -->
    <div class="row">
        <!-- Equipo Azul -->
        <div class="col-md-6">
            <div class="card participant-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        {% set team100_participants = match.all_participants | selectattr('team_id', 'equalto', 100) | list %}
                        {% set team100_won = team100_participants[0].win if team100_participants else false %}
                        {% if team100_participants %}
                            {% if team100_won %}<i class="fas fa-trophy text-warning me-2"></i>{% endif %}
                            Victoria{% else %}Derrota{% endif %} - Equipo Azul
                    {% else %}
                        Equipo Azul
                    {% endif %}
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% for participante in match.all_participants %}
                        {% if participante.team_id == 100 %}
                        <div class="participant-row {{ 'table-warning' if participante.summoner_name == perfil.game_name.split('#')[0] else '' }} {{ 'match-row-win' if participante.win else 'match-row-loss' }}">
                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ participante.champion_name }}.png" 
                                 alt="{{ participante.champion_name }}" 
                                 class="participant-champion">
                            <div class="participant-name">
                                {{ participante.summoner_name }}
                                {% if participante.summoner_name == perfil.game_name.split('#')[0] %}
                                <span class="badge bg-warning text-dark ms-1">Tú</span>
                                {% endif %}
                            </div>
                            <div class="participant-stats">
                                <div class="participant-spells">
                                    {% if participante.get('summoner_spell_1_id') %}
                                        <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/{{ participante.get('summoner_spell_1_id') }}.png" alt="Spell 1">
                                    {% endif %}
                                    {% if participante.get('summoner_spell_2_id') %}
                                        <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/{{ participante.get('summoner_spell_2_id') }}.png" alt="Spell 2">
                                    {% endif %}
                                </div>
                                <div class="participant-runes">
                                    {% if participante.get('perk_main_id') %}
                                        <img src="https://ddragon.leagueoflegends.com/cdn/img/{{ participante.get('perk_main_id') }}" alt="Main Rune" class="keystone">
                                    {% endif %}
                                    {% if participante.get('perk_sub_id') %}
                                        <img src="https://ddragon.leagueoflegends.com/cdn/img/{{ participante.get('perk_sub_id') }}" alt="Sub Rune" class="sub-rune">
                                    {% endif %}
                                </div>
                                <div class="participant-kda">
                                    {{ participante.kills }}/{{ participante.deaths }}/{{ participante.assists }}
                                </div>
                                <div class="participant-items">
                                    {% set items = participante.get('items', []) %}
                                    {% for item_id in items %}
                                        {% if item_id > 0 %}
                                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/item/{{ item_id }}.png" alt="Item">
                                        {% else %}
                                            <div style="width:22px; height:22px; background-color: rgba(0,0,0,0.1); border-radius: 3px;"></div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Equipo Rojo -->
        <div class="col-md-6">
            <div class="card participant-card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        {% set team200_participants = match.all_participants | selectattr('team_id', 'equalto', 200) | list %}
                        {% set team200_won = team200_participants[0].win if team200_participants else false %}
                        {% if team200_participants %}
                            {% if team200_won %}<i class="fas fa-trophy text-warning me-2"></i>{% endif %}
                            Victoria{% else %}Derrota{% endif %} - Equipo Rojo
                    {% else %}
                        Equipo Rojo
                    {% endif %}
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% for participante in match.all_participants %}
                        {% if participante.team_id == 200 %}
                        <div class="participant-row {{ 'table-warning' if participante.summoner_name == perfil.game_name.split('#')[0] else '' }} {{ 'match-row-win' if participante.win else 'match-row-loss' }}">
                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/champion/{{ participante.champion_name }}.png" 
                                 alt="{{ participante.champion_name }}" 
                                 class="participant-champion">
                            <div class="participant-name">
                                {{ participante.summoner_name }}
                                {% if participante.summoner_name == perfil.game_name.split('#')[0] %}
                                <span class="badge bg-warning text-dark ms-1">Tú</span>
                                {% endif %}
                            </div>
                            <div class="participant-stats">
                                <div class="participant-spells">
                                    {% if participante.get('summoner_spell_1_id') %}
                                        <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/{{ participante.get('summoner_spell_1_id') }}.png" alt="Spell 1">
                                    {% endif %}
                                    {% if participante.get('summoner_spell_2_id') %}
                                        <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/spell/{{ participante.get('summoner_spell_2_id') }}.png" alt="Spell 2">
                                    {% endif %}
                                </div>
                                <div class="participant-runes">
                                    {% if participante.get('perk_main_id') %}
                                        <img src="https://ddragon.leagueoflegends.com/cdn/img/{{ participante.get('perk_main_id') }}" alt="Main Rune" class="keystone">
                                    {% endif %}
                                    {% if participante.get('perk_sub_id') %}
                                        <img src="https://ddragon.leagueoflegends.com/cdn/img/{{ participante.get('perk_sub_id') }}" alt="Sub Rune" class="sub-rune">
                                    {% endif %}
                                </div>
                                <div class="participant-kda">
                                    {{ participante.kills }}/{{ participante.deaths }}/{{ participante.assists }}
                                </div>
                                <div class="participant-items">
                                    {% set items = participante.get('items', []) %}
                                    {% for item_id in items %}
                                        {% if item_id > 0 %}
                                            <img src="https://ddragon.leagueoflegends.com/cdn/{{ ddragon_version }}/img/item/{{ item_id }}.png" alt="Item">
                                        {% else %}
                                            <div style="width:22px; height:22px; background-color: rgba(0,0,0,0.1); border-radius: 3px;"></div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <div class="alert alert-warning">
        No se encontraron detalles de la partida.
    </div>
    {% endif %}
</div>

<footer class="footer mt-5 py-3 bg-light">
    <div class="container text-center">
        <span class="text-muted">Proyecto SoloQ Cerditos - Desarrollado por Sepevalle &copy; 2024</span>
    </div>
</footer>

<script>
    // Banner dynamic images
    document.addEventListener('DOMContentLoaded', function() {
        const bannerImg = document.getElementById('banner-img');
        const banners = [
            "https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/refs/heads/main/banners/Banner5.png"
        ];
        let currentBannerIndex = 0;

        function changeBanner() {
            currentBannerIndex = (currentBannerIndex + 1) % banners.length;
            bannerImg.src = banners[currentBannerIndex];
        }
        setInterval(changeBanner, 5000);

        // Lateral images dynamic
        const leftBanner = document.getElementById('left-banner');
        const rightBanner = document.getElementById('right-banner');
        const lateralBanners = [
            "https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/1.jpg",
            "https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/2.jpg",
            "https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/3.jpg",
            "https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/4.jpg",
            "https://raw.githubusercontent.com/Sepevalle/SoloQ-Cerditos/main/bannerlateral/5.jpg"
        ];
        let currentLateralBannerIndex = 0;

        function changeLateralBanner() {
            currentLateralBannerIndex = (currentLateralBannerIndex + 1) % lateralBanners.length;
            leftBanner.src = lateralBanners[currentLateralBannerIndex];
            rightBanner.src = lateralBanners[currentLateralBannerIndex];
        }
        setInterval(changeLateralBanner, 5000);
    });
</script>
{% endblock %}
